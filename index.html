<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metro Safety | Station Master Command Console</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --neon-green: #00ff00; --danger-red: rgba(220, 38, 38, 0.4); --terminal-black: #050505; }
        body { background-color: #000; color: #ccc; overflow: hidden; font-family: 'Courier New', monospace; text-transform: uppercase; }
        
        .nav-btn { padding: 14px 28px; border-right: 1px solid #222; color: #555; font-weight: 800; background: #000; cursor: pointer; transition: all 0.3s ease; letter-spacing: 1px; }
        .nav-btn:hover { color: #fff; background: #111; }
        .nav-btn.active { color: var(--neon-green); background: #051a05; border-bottom: 3px solid var(--neon-green); }

        .viewport-container { position: relative; width: 100%; height: 100%; background: #000; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 1px solid #111; }
        video { width: 100% !important; height: 100% !important; object-fit: cover; position: absolute; top: 0; left: 0; z-index: 1; }
        svg { position: absolute; inset: 0; width: 100% !important; height: 100% !important; z-index: 10; pointer-events: none; }

        /* CRITICAL FIX: Locked Sidebar Layout */
        #config-view-container {
            display: grid;
            grid-template-cols: 1fr 380px;
            height: 100%;
        }

        .sidebar-locked {
            display: flex;
            flex-direction: column;
            height: 100%; /* Fixes the height to the screen */
            background: #0f172a; /* Slate 900 */
            border-left: 1px solid #334155;
            padding: 1.5rem;
        }

        #slider-panel { 
            flex: 1; /* This takes up all available middle space */
            overflow-y: auto !important; 
            margin: 1rem 0;
            padding-right: 10px;
        }

        /* Scrollbar styling */
        #slider-panel::-webkit-scrollbar { width: 4px; }
        #slider-panel::-webkit-scrollbar-track { background: #0a0a0a; }
        #slider-panel::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        #slider-panel::-webkit-scrollbar-thumb:hover { background: var(--neon-green); }

        .unsafe-overlay-tint { fill: var(--danger-red); transition: opacity 0.5s ease; }
        .violation-card { background: rgba(15, 15, 15, 0.9); border-left: 4px solid #dc2626; animation: alert-pulse 2s infinite; }
        @keyframes alert-pulse { 0% { border-color: #dc2626; } 50% { border-color: #450a0a; } 100% { border-color: #dc2626; } }

        #image-modal img { max-height: 80vh; object-fit: contain; }
    </style>
</head>
<body class="flex flex-col h-screen">

    <header class="h-16 bg-slate-900 border-b border-slate-700 flex justify-between items-center px-6 shrink-0 z-50">
        <div class="flex items-center gap-8">
            <div class="flex flex-col">
                <span class="text-xl font-black text-white tracking-tighter">
                    <i class="fa-solid fa-subway text-sky-500 mr-2"></i>METRO-SAFETY <span class="text-green-500">v4.0</span>
                </span>
                <span class="text-[9px] text-slate-500 font-mono">STATION MASTER COMMAND INTERFACE</span>
            </div>
            <nav class="flex h-16">
                <button onclick="window.switchTab('monitor')" id="tab-monitor" class="nav-btn active">LIVE MONITOR</button>
                <button onclick="window.switchTab('config')" id="tab-config" class="nav-btn">ZONE CALIBRATION</button>
                <button onclick="window.switchTab('prosecute')" id="tab-prosecute" class="nav-btn">PROSECUTION LOG</button>
            </nav>
        </div>
        
        <div class="flex items-center gap-6 font-mono">
            <div class="text-right">
                <div id="clock" class="text-sm text-white font-bold">00:00:00</div>
                <div class="text-[10px] text-green-500 font-bold uppercase">System Online</div>
            </div>
        </div>
    </header>

    <main class="flex-1 relative overflow-hidden bg-black">
        
        <div id="view-monitor" class="absolute inset-0 grid grid-cols-[1fr_420px]">
            <div class="viewport-container border-r border-slate-800">
                <video id="monitor-video" autoplay playsinline muted></video>
                <svg id="safety-overlay"></svg>
                <button onclick="window.triggerFaceCapture('MANUAL')" class="absolute bottom-8 right-8 bg-red-600 text-white w-16 h-16 rounded-full z-50 flex items-center justify-center shadow-lg">
                    <i class="fa-solid fa-camera text-2xl"></i>
                </button>
            </div>
            <div class="bg-slate-900 flex flex-col">
                <div class="p-4 border-b border-slate-800 text-white text-xs font-bold tracking-widest">LIVE INTRUSION ALERTS</div>
                <div id="alerts-feed" class="flex-1 overflow-y-auto p-4 space-y-4"></div>
            </div>
        </div>

        <div id="view-config" class="absolute inset-0 hidden">
            <div id="config-view-container">
                <div class="viewport-container">
                    <video id="config-video" autoplay playsinline muted class="opacity-40"></video>
                    <svg id="config-overlay"></svg>
                </div>
                
                <div class="sidebar-locked">
                    <div class="shrink-0">
                        <h3 class="text-white font-bold mb-6 flex items-center gap-2">
                            <i class="fa-solid fa-sliders text-sky-500"></i> ZONE CALIBRATION
                        </h3>
                        
                        <div class="bg-black/40 p-4 rounded-lg border border-slate-800">
                            <label class="text-[10px] text-slate-500 block mb-3 font-bold uppercase">Node Density (2-10)</label>
                            <input id="pointCount" type="range" min="2" max="10" value="4" class="w-full h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-sky-500">
                            <div class="flex justify-between text-sky-500 font-mono text-[10px] mt-2">
                                <span>MIN</span>
                                <span id="pointCountLabel" class="text-white bg-sky-600 px-2 rounded">4</span>
                                <span>MAX</span>
                            </div>
                        </div>
                    </div>

                    <div id="slider-panel">
                        </div>

                    <div class="shrink-0 pt-2">
                        <button onclick="window.saveConfig()" class="w-full bg-green-600 hover:bg-green-500 text-white py-4 rounded font-black tracking-widest transition-all shadow-lg">
                            COMMIT ZONE TO DATABASE
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-prosecute" class="absolute inset-0 hidden bg-slate-950 p-8 overflow-y-auto">
            <div class="max-w-7xl mx-auto">
                <h2 class="text-2xl font-black text-white border-b border-slate-800 pb-4 mb-8">PROSECUTION RECORDS</h2>
                <div id="prosecution-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"></div>
            </div>
        </div>

        <div id="safety-side-picker" class="hidden absolute inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center z-[2000]">
            <div class="bg-slate-900 border border-slate-700 p-10 rounded-2xl text-center max-w-lg w-full">
                <h3 class="text-2xl font-bold text-white mb-8">WHICH SEGMENT IS SAFE?</h3>
                <div class="grid grid-cols-2 gap-6">
                    <button onclick="window.setSafetySide('left')" class="bg-slate-800 hover:bg-green-900/40 border-2 border-slate-700 p-8 rounded-xl transition-all">
                        <i class="fa-solid fa-arrow-left text-3xl mb-4 block"></i>
                        <span class="text-white font-bold">LEFT SIDE</span>
                    </button>
                    <button onclick="window.setSafetySide('right')" class="bg-slate-800 hover:bg-green-900/40 border-2 border-slate-700 p-8 rounded-xl transition-all">
                        <i class="fa-solid fa-arrow-right text-3xl mb-4 block"></i>
                        <span class="text-white font-bold">RIGHT SIDE</span>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getFirestore, doc, setDoc, collection, query, orderBy, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBoWtfLODLrDhRKkMew0sLceDgHBNAQAPM", projectId: "metro-safety-system" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let controlPoints = [];
        let nodeCount = 4;
        let safeSide = 'left';

        window.initListeners = () => {
            const q = query(collection(db, "violations"), orderBy("timestamp", "desc"));
            onSnapshot(q, (snapshot) => {
                const list = document.getElementById('prosecution-list');
                const feed = document.getElementById('alerts-feed');
                if (list) list.innerHTML = "";
                if (feed) feed.innerHTML = "";

                snapshot.forEach(docSnap => {
                    const d = docSnap.data();
                    const card = document.createElement('div');
                    card.className = "bg-slate-900 border border-slate-800 rounded-xl overflow-hidden";
                    card.innerHTML = `
                        <img src="${d.image_base64}" class="w-full h-40 object-cover">
                        <div class="p-4">
                            <div class="text-[10px] text-red-500 font-bold mb-2">${d.trigger_type}</div>
                            <button onclick="window.deleteRecord('${docSnap.id}')" class="w-full bg-red-900/20 text-red-500 py-2 text-[10px] rounded">PURGE</button>
                        </div>`;
                    if (list) list.appendChild(card);
                    if (feed) feed.appendChild(card.cloneNode(true));
                });
            });
        };

        window.updatePoint = (index, axis, value) => {
            controlPoints[index][axis] = value / 100;
            const labels = document.querySelectorAll('.pos-label');
            if (labels[index]) labels[index].innerText = `X:${Math.round(controlPoints[index].x * 100)}% Y:${Math.round(controlPoints[index].y * 100)}%`;
            window.drawLines();
        };

        window.renderSliders = () => {
            const panel = document.getElementById('slider-panel');
            panel.innerHTML = '';
            controlPoints.forEach((pt, i) => {
                const group = document.createElement('div');
                group.className = "p-4 bg-black/60 border border-slate-800 rounded-xl mb-4";
                group.innerHTML = `
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-sky-500 font-black text-[10px]">NODE ${i + 1}</span>
                        <span class="pos-label text-[9px] text-slate-500 font-mono">X:${Math.round(pt.x * 100)}% Y:${Math.round(pt.y * 100)}%</span>
                    </div>
                    <div class="space-y-4">
                        <input type="range" min="0" max="100" value="${pt.x * 100}" oninput="window.updatePoint(${i}, 'x', this.value)" class="w-full h-1 bg-slate-800 appearance-none accent-sky-500">
                        <input type="range" min="0" max="100" value="${pt.y * 100}" oninput="window.updatePoint(${i}, 'y', this.value)" class="w-full h-1 bg-slate-800 appearance-none accent-red-600">
                    </div>`;
                panel.appendChild(group);
            });
        };

        window.drawLines = () => {
            const targets = ['safety-overlay', 'config-overlay'];
            targets.forEach(id => {
                const svg = document.getElementById(id);
                const parent = svg.parentElement;
                const w = parent.clientWidth, h = parent.clientHeight;
                if (w === 0) return;
                svg.setAttribute('viewBox', `0 0 ${w} ${h}`);
                
                let path = `M ${controlPoints[0].x * w} ${controlPoints[0].y * h}`;
                for (let j = 1; j < controlPoints.length; j++) path += ` L ${controlPoints[j].x * w} ${controlPoints[j].y * h}`;

                let shade = path;
                if (safeSide === 'left') shade += ` L ${w} ${controlPoints[nodeCount-1].y * h} L ${w} ${h} L 0 ${h} L 0 ${controlPoints[0].y * h} Z`;
                else shade += ` L 0 ${controlPoints[nodeCount-1].y * h} L 0 ${h} L ${w} ${h} L ${w} ${controlPoints[0].y * h} Z`;

                svg.innerHTML = `
                    <path d="${shade}" class="unsafe-overlay-tint" />
                    <path d="${path}" stroke="#00ff00" stroke-width="4" fill="none" />
                    ${id === 'config-overlay' ? controlPoints.map(p => `<circle cx="${p.x*w}" cy="${p.y*h}" r="5" fill="white" />`).join('') : ''}
                `;
            });
        };

        window.switchTab = (target) => {
            document.querySelectorAll('main > div').forEach(div => div.classList.add('hidden'));
            document.getElementById(`view-${target}`).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tab-${target}`).classList.add('active');
            setTimeout(window.drawLines, 50);
        };

        window.saveConfig = () => document.getElementById('safety-side-picker').classList.remove('hidden');

        window.setSafetySide = async (choice) => {
            safeSide = choice;
            await setDoc(doc(db, "config", "station_settings"), { points: controlPoints, safeSide: safeSide });
            document.getElementById('safety-side-picker').classList.add('hidden');
            window.switchTab('monitor');
        };

        document.getElementById('pointCount').oninput = (e) => {
            nodeCount = parseInt(e.target.value);
            document.getElementById('pointCountLabel').innerText = nodeCount;
            controlPoints = Array.from({length: nodeCount}, (_, i) => ({ x: i / (nodeCount - 1), y: 0.5 }));
            window.renderSliders();
            window.drawLines();
        };

        // Execution
        controlPoints = Array.from({length: 4}, (_, i) => ({ x: i / 3, y: 0.5 }));
        window.renderSliders();
        window.initListeners();
        setInterval(() => document.getElementById('clock').innerText = new Date().toLocaleTimeString(), 1000);
        
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 1280, height: 720 } });
            document.getElementById('monitor-video').srcObject = stream;
            document.getElementById('config-video').srcObject = stream;
        } catch(e) { console.error("Camera access denied"); }
    </script>
</body>
</html>
