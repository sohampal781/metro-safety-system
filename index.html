<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metro Safety | Station Master Console</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
   <style>
        /* GOVERNMENT STANDARD THEME */
        body { 
            background-color: #000000; 
            color: #cccccc; 
            overflow: hidden; 
            font-family: 'Courier New', Courier, monospace; /* Monospace for official look */
            text-transform: uppercase;
        }

        /* Override Tailwind Colors for Dark Mode */
        .bg-slate-900, .bg-slate-800 { background-color: #0a0a0a !important; border-color: #333 !important; }
        .bg-slate-700 { background-color: #111 !important; border: 1px solid #333 !important; }
        .border-slate-700 { border-color: #222 !important; }
        .text-slate-500 { color: #666 !important; }
        
        /* Industrial Tab Navigation */
        .nav-btn {
            padding: 12px 24px;
            border: 1px solid transparent;
            border-right: 1px solid #222;
            color: #555;
            font-weight: bold;
            letter-spacing: 1px;
            background: #000;
            transition: all 0.2s;
            cursor: pointer;
        }
        .nav-btn:hover { background: #111; color: #fff; }
        .nav-btn.active {
            color: #00ff00; /* Neon Green Active State */
            background: #051a05;
            border-bottom: 2px solid #00ff00;
        }

        /* Video Container - FULL VIEW */
        .video-wrapper {
            position: relative;
            width: 100%; height: 100%;
            background: #000;
            display: flex; justify-content: center; align-items: center;
            border: 1px solid #222;
        }
        
        video { 
            width: auto; height: auto; 
            max-width: 100%; max-height: 100%;
            object-fit: contain; 
        }

        /* LAYERS */
        #zone-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: crosshair; z-index: 50; }
        #detect-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 40; }
        #safety-overlay { display: none; /* KEEPS TRIP LINE HIDDEN */ }

        /* Status Badges - Official Look */
        .status-badge {
            display: inline-flex; items-center; gap: 8px;
            padding: 4px 12px; border: 1px solid #333;
            font-size: 0.7rem; letter-spacing: 0.1em;
            background: #111; color: #888;
        }
        .status-ok { border-color: #064e3b; color: #34d399; background: #022c22; }
    </style>
</head>
<body class="flex flex-col h-screen">

    <header class="h-14 bg-slate-900 border-b border-slate-700 flex justify-between items-center px-4 shrink-0">
        <div class="flex items-center gap-4">
            <div class="text-xl font-bold text-white tracking-tight">
                <i class="fa-solid fa-subway text-sky-500 mr-2"></i>SURVEILLANCE <span class="text-green-500">COMMAND</span>
            </div>
            <div class="h-6 w-px bg-slate-700 mx-2"></div>
            <nav class="flex">
                <button onclick="switchTab('monitor')" id="tab-monitor" class="nav-btn active">
                    <i class="fa-solid fa-eye mr-2"></i>Live Monitor
                </button>
                <button onclick="switchTab('config')" id="tab-config" class="nav-btn">
                    <i class="fa-solid fa-pen-ruler mr-2"></i>Zone Config
                </button>
                <button onclick="switchTab('history')" id="tab-history" class="nav-btn">
                    <i class="fa-solid fa-clock-rotate-left mr-2"></i>History Log
                </button>
            </nav>
        </div>
        
        <div class="flex items-center gap-4">
            <div id="connection-status" class="status-badge status-ok">
                <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                SYSTEM ONLINE
            </div>
            <div class="text-xs text-slate-500 font-mono text-right">
                <div id="clock">12:00:00</div>
                <div>CAM-01 [MASTER]</div>
            </div>
        </div>
    </header>

    <main class="flex-1 relative overflow-hidden">
        
        <div id="view-monitor" class="absolute inset-0 grid grid-cols-[1fr_400px]">
            <div class="video-wrapper relative group">
                <video id="monitor-video" autoplay playsinline muted></video>
                <svg id="safety-overlay" class="absolute inset-0 w-full h-full pointer-events-none"></svg>
                
                <div class="absolute top-4 left-4 bg-black/60 backdrop-blur px-3 py-1 rounded border-l-4 border-sky-500 text-xs text-white">
                    Monitoring Zone: <span id="zone-status-text">Active</span>
                </div>
            </div>

            <div class="bg-slate-800 border-l border-slate-700 flex flex-col">
                <div class="p-4 bg-slate-900 border-b border-slate-700 flex justify-between items-center">
                    <h3 class="font-bold text-white">Live Violations</h3>
                    <span class="bg-red-900/50 text-red-400 text-xs px-2 py-1 rounded">Real-time</span>
                </div>
                
                <div id="alerts-feed" class="flex-1 overflow-y-auto p-4 space-y-3">
                    <div class="text-center text-slate-500 mt-10 italic text-sm">
                        Waiting for detection from Python backend...
                    </div>
                </div>
            </div>
        </div>

        <div id="view-config" class="absolute inset-0 hidden flex flex-col bg-slate-900">
            <div class="h-12 bg-slate-800 border-b border-slate-700 flex items-center px-4 gap-4 justify-between">
                <div class="flex gap-2">
                    <button onclick="startDrawing()" class="bg-sky-600 hover:bg-sky-500 text-white px-3 py-1.5 rounded text-sm font-semibold transition">
                        <i class="fa-solid fa-pencil mr-2"></i>New Curve
                    </button>
                    <button onclick="clearZone()" class="bg-slate-700 hover:bg-slate-600 text-slate-200 px-3 py-1.5 rounded text-sm font-semibold transition">
                        <i class="fa-solid fa-trash mr-2"></i>Clear
                    </button>
                </div>
                <div class="flex items-center gap-2 text-sm text-slate-400">
                    <i class="fa-solid fa-circle-info text-sky-500"></i>
                    <span>Instructions: Click points on the video to draw the platform edge. Double-click to finish.</span>
                </div>
                <button onclick="saveConfig()" class="bg-green-600 hover:bg-green-500 text-white px-4 py-1.5 rounded text-sm font-bold shadow-lg shadow-green-900/20">
                    <i class="fa-solid fa-floppy-disk mr-2"></i>Save Zone
                </button>
            </div>

            <div class="flex-1 relative bg-black video-wrapper">
                <video id="config-video" autoplay playsinline muted class="opacity-75"></video>
                <canvas id="zone-canvas"></canvas>
                <canvas id="detect-layer" class="absolute inset-0 w-full h-full pointer-events-none"></canvas>
                <div id="side-selector" class="hidden absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-slate-900 p-4 rounded-lg shadow-2xl border border-slate-600 text-center">
                    <h4 class="text-white font-bold mb-3">Which side is UNSAFE?</h4>
                    <div class="flex gap-3">
                        <button onclick="setUnsafeSide('left')" class="bg-red-900/50 border border-red-500 hover:bg-red-800 text-red-200 px-4 py-2 rounded">
                            <i class="fa-solid fa-arrow-left mr-2"></i>Left / Top
                        </button>
                        <button onclick="setUnsafeSide('right')" class="bg-red-900/50 border border-red-500 hover:bg-red-800 text-red-200 px-4 py-2 rounded">
                            Right / Bottom<i class="fa-solid fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-history" class="absolute inset-0 hidden bg-slate-900 p-8 overflow-auto">
            <h2 class="text-2xl font-bold text-white mb-6">Violation Log (Past 24h)</h2>
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="text-slate-400 border-b border-slate-700">
                        <th class="p-3">Time</th>
                        <th class="p-3">ID</th>
                        <th class="p-3">Status</th>
                        <th class="p-3">Action</th>
                    </tr>
                </thead>
                <tbody id="history-table" class="text-slate-300">
                    </tbody>
            </table>
        </div>

    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getFirestore, collection, query, orderBy, onSnapshot, doc, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

        // --- FIREBASE CONFIG (PUT YOUR KEYS HERE) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBoWtfLODLrDhRKkMew0sLceDgHBNAQAPM",
            authDomain: "metro-safety-system.firebaseapp.com",
            projectId: "metro-safety-system",
            storageBucket: "metro-safety-system.appspot.com",
            messagingSenderId: "783283638023",
            appId: "1:783283638023:web:52d0d7ab6c6d7e1677bfa2"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- GLOBAL STATE ---
        let points = [];
        let isDrawing = false;
        let unsafeSide = 'right'; // default
        
        // --- 1. VIDEO SETUP (Simulating RTSP with Webcam) ---
        async function startCameras() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                document.getElementById('monitor-video').srcObject = stream;
                document.getElementById('config-video').srcObject = stream;
            } catch (e) {
                console.error("Camera failed", e);
                alert("Camera access denied. In production, this would be an RTSP stream.");
            }
        }
        startCameras();

        // --- 2. TAB SWITCHING LOGIC ---
        window.switchTab = (tabName) => {
            // Hide all views
            ['monitor', 'config', 'history'].forEach(t => {
                document.getElementById(`view-${t}`).classList.add('hidden');
                document.getElementById(`tab-${t}`).classList.remove('active');
            });
            // Show selected
            document.getElementById(`view-${tabName}`).classList.remove('hidden');
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            // If switching to monitor, redraw the safety overlay
            if(tabName === 'monitor') renderSafetyOverlay();
        };

// --- FIND THE "DRAWING LOGIC" SECTION AND REPLACE WITH THIS ---

// 1. Get elements
const canvas = document.getElementById('zone-canvas');
const ctx = canvas.getContext('2d');
const videoContainer = document.querySelector('.video-wrapper'); // We need the container

// 2. Resize function - Force canvas to match container size exactly
function resizeCanvas() {
    if(videoContainer) {
        canvas.width = videoContainer.offsetWidth;
        canvas.height = videoContainer.offsetHeight;
        draw(); // Redraw if we resize
    }
}
window.addEventListener('resize', resizeCanvas);

// 3. Start Drawing Action
window.startDrawing = () => {
    resizeCanvas(); // Ensure size is correct before starting
    points = [];
    isDrawing = true;
    
    // Clear previous
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // UI Updates
    document.getElementById('side-selector').classList.add('hidden');
    canvas.classList.remove('locked'); // Make sure it captures clicks
    canvas.style.pointerEvents = "auto"; // FORCE clicks to be enabled
    
    alert("Drawing Mode Active: Click points on the video. Double-click to finish.");
};

// 4. Mouse Down (Click to add point)
canvas.addEventListener('mousedown', (e) => {
    if(!isDrawing) return;
    
    // Get correct coordinates relative to the canvas, not the window
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;

    points.push({ x, y });
    draw();
});

// 5. Mouse Move (Rubber band effect)
canvas.addEventListener('mousemove', (e) => {
    if(!isDrawing || points.length === 0) return;
    
    draw(); // Draw established lines
    
    // Draw "rubber band" line to cursor
    const rect = canvas.getBoundingClientRect();
    const mouseX = e.clientX - rect.left;
    const mouseY = e.clientY - rect.top;
    
    ctx.beginPath();
    ctx.moveTo(points[points.length-1].x, points[points.length-1].y);
    ctx.lineTo(mouseX, mouseY);
    ctx.strokeStyle = "rgba(255, 255, 0, 0.5)"; // Faint yellow
    ctx.lineWidth = 2;
    ctx.stroke();
});

// 6. Double Click (Finish)
canvas.addEventListener('dblclick', (e) => {
    if(!isDrawing) return;
    isDrawing = false;
    canvas.style.pointerEvents = "none"; // Stop capturing clicks so you can click other buttons
    draw();
    document.getElementById('side-selector').classList.remove('hidden');
});

// 7. The Draw Function (Visuals)
function draw() {
    // Clear screen
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Draw the path
    if (points.length > 0) {
        ctx.beginPath();
        ctx.lineWidth = 4;
        ctx.strokeStyle = "#fbbf24"; // Bright Yellow
        ctx.lineCap = "round";
        ctx.lineJoin = "round";
        
        ctx.moveTo(points[0].x, points[0].y);
        for (let i = 1; i < points.length; i++) {
            ctx.lineTo(points[i].x, points[i].y);
        }
        ctx.stroke();
        
        // Draw white dots at click points
        ctx.fillStyle = "white";
        points.forEach(p => {
            ctx.beginPath();
            ctx.arc(p.x, p.y, 5, 0, Math.PI*2);
            ctx.fill();
        });
    }
}
        window.setUnsafeSide = (side) => {
            unsafeSide = side;
            document.getElementById('side-selector').classList.add('hidden');
            alert(`Zone Configured! The ${side.toUpperCase()} side is now marked as DANGER.`);
        };

        // Save Config to Firebase (for Python Backend to read)
        window.saveConfig = async () => {
            if(points.length < 2) return alert("Please draw a line first.");
            
            // We save NORMALIZED coordinates (0.0 to 1.0) so it works on any resolution
            const normalizedPoints = points.map(p => ({
                x: p.x / canvas.width,
                y: p.y / canvas.height
            }));

            const configData = {
                station_id: "STN-01",
                poly_points: normalizedPoints,
                unsafe_side: unsafeSide,
                updated_at: new Date().toISOString()
            };

            // 1. Save locally for immediate UI update
            localStorage.setItem('metro_zone_config', JSON.stringify(configData));
            
            // 2. Save to Firebase (Real World)
            try {
                await setDoc(doc(db, "config", "station_settings"), configData);
                alert("Configuration Saved to Cloud! The AI Camera will now respect this boundary.");
                renderSafetyOverlay(); // Update monitor view
                switchTab('monitor'); // Go back to monitor
            } catch (e) {
                console.error("Save failed", e);
                alert("Error saving to cloud. Check console.");
            }
        };
// --- 4. LIVE MONITOR OVERLAY (Green Box Auto-Detect) ---
        const detectCanvas = document.getElementById('detect-layer');
        const dCtx = detectCanvas.getContext('2d');
        
        // Resize detect canvas to match video
        function resizeDetectCanvas() {
            if(detectCanvas) {
                detectCanvas.width = detectCanvas.parentElement.offsetWidth;
                detectCanvas.height = detectCanvas.parentElement.offsetHeight;
            }
        }
        window.addEventListener('resize', resizeDetectCanvas);

        // Animation Loop for "Auto Detect" Green Box
        let boxX = 0, boxY = 0;
        let speedX = 2, speedY = 1.5;
        
        function animateDetection() {
            resizeDetectCanvas();
            dCtx.clearRect(0, 0, detectCanvas.width, detectCanvas.height);
            
            const w = detectCanvas.width;
            const h = detectCanvas.height;
            
            // Initialize box position if 0
            if(boxX === 0) { boxX = w/2 - 100; boxY = h/2 - 100; }

            // Move the box slightly (Simulating "Scanning")
            boxX += speedX;
            boxY += speedY;
            
            // Bounce off edges (Keep box inside view)
            if(boxX > w - 250 || boxX < 50) speedX *= -1;
            if(boxY > h - 250 || boxY < 50) speedY *= -1;

            // Draw Green Detection Box
            dCtx.strokeStyle = "#00ff00"; // Bright Green
            dCtx.lineWidth = 2;
            dCtx.strokeRect(boxX, boxY, 200, 200);

            // Draw "Corners" for a Pro Look
            dCtx.strokeStyle = "#4ade80";
            dCtx.lineWidth = 4;
            const size = 200;
            const len = 30; // corner length
            
            dCtx.beginPath();
            // Top Left
            dCtx.moveTo(boxX, boxY + len); dCtx.lineTo(boxX, boxY); dCtx.lineTo(boxX + len, boxY);
            // Top Right
            dCtx.moveTo(boxX + size - len, boxY); dCtx.lineTo(boxX + size, boxY); dCtx.lineTo(boxX + size, boxY + len);
            // Bottom Right
            dCtx.moveTo(boxX + size, boxY + size - len); dCtx.lineTo(boxX + size, boxY + size); dCtx.lineTo(boxX + size - len, boxY + size);
            // Bottom Left
            dCtx.moveTo(boxX + len, boxY + size); dCtx.lineTo(boxX, boxY + size); dCtx.lineTo(boxX, boxY + size - len);
            dCtx.stroke();

            // Text Label
            dCtx.fillStyle = "#00ff00";
            dCtx.font = "bold 12px monospace";
            dCtx.fillText("AUTO-DETECT: SCANNING", boxX + 5, boxY - 8);

            requestAnimationFrame(animateDetection);
        }

        // Start animation immediately
        setInterval(resizeDetectCanvas, 1000); // Check size periodically
        animateDetection();
        // --- 5. REAL-TIME ALERTS (Listener) ---
        const alertsFeed = document.getElementById('alerts-feed');
        const historyTable = document.getElementById('history-table');

        // Listen for ANY change in 'violations' collection
        const q = query(collection(db, "violations"), orderBy("time", "desc"));
        
        onSnapshot(q, (snapshot) => {
            alertsFeed.innerHTML = "";
            historyTable.innerHTML = "";

            if(snapshot.empty) {
                alertsFeed.innerHTML = `<div class="text-center text-slate-500 mt-10">System Armed. No violations.</div>`;
            }

            snapshot.forEach(snap => {
                const data = snap.data();
                const id = snap.id;
                
                // 1. Add to Sidebar (Only Pending/Recent)
                if(!data.approved) {
                    const card = document.createElement('div');
                    card.className = "bg-slate-700 rounded p-3 border-l-4 border-red-500 shadow-md animate-pulse";
                    card.innerHTML = `
                        <div class="flex justify-between text-xs text-slate-400 mb-2">
                            <span>CAM-01</span>
                            <span>${data.time.split(' ')[1]}</span>
                        </div>
                        <img src="${data.face_url || 'https://placehold.co/300x200?text=No+Signal'}" class="w-full h-32 object-cover bg-black mb-2 rounded">
                        <div class="flex justify-between items-center">
                            <span class="text-white font-mono text-sm">${data.rfid || 'Detecting ID...'}</span>
                            <button onclick="window.approveFine('${id}')" class="bg-red-600 hover:bg-red-700 text-white text-xs px-3 py-1.5 rounded font-bold">
                                FINE
                            </button>
                        </div>
                    `;
                    alertsFeed.appendChild(card);
                }

                // 2. Add to History Table
                const row = document.createElement('tr');
                row.className = "border-b border-slate-700 hover:bg-slate-800";
                row.innerHTML = `
                    <td class="p-3 text-sm">${data.time}</td>
                    <td class="p-3 font-mono text-sky-400">${data.rfid || 'UNK'}</td>
                    <td class="p-3"><span class="px-2 py-0.5 rounded text-xs ${data.approved ? 'bg-green-900 text-green-400' : 'bg-red-900 text-red-400'}">${data.approved ? 'RESOLVED' : 'PENDING'}</span></td>
                    <td class="p-3 text-xs text-slate-500">${data.approved ? 'Auto-Debited' : '-'}</td>
                `;
                historyTable.appendChild(row);
            });
        });

        // Global function for the button
        window.approveFine = async (docId) => {
            await updateDoc(doc(db, "violations", docId), {
                approved: true,
                processed_at: new Date().toISOString()
            });
        };

        // Clock Update
        setInterval(() => {
            document.getElementById('clock').innerText = new Date().toLocaleTimeString();
        }, 1000);

    </script>
</body>
</html>
