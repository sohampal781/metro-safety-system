<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metro Safety | Station Master Console</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
   <style>
        /* GOVERNMENT STANDARD THEME */
        body { 
            background-color: #000000; 
            color: #cccccc; 
            overflow: hidden; 
            font-family: 'Courier New', Courier, monospace; /* Monospace for official look */
            text-transform: uppercase;
        }

        /* Override Tailwind Colors for Dark Mode */
        .bg-slate-900, .bg-slate-800 { background-color: #0a0a0a !important; border-color: #333 !important; }
        .bg-slate-700 { background-color: #111 !important; border: 1px solid #333 !important; }
        .border-slate-700 { border-color: #222 !important; }
        .text-slate-500 { color: #666 !important; }
        
        /* Industrial Tab Navigation */
        .nav-btn {
            padding: 12px 24px;
            border: 1px solid transparent;
            border-right: 1px solid #222;
            color: #555;
            font-weight: bold;
            letter-spacing: 1px;
            background: #000;
            transition: all 0.2s;
            cursor: pointer;
        }
        .nav-btn:hover { background: #111; color: #fff; }
        .nav-btn.active {
            color: #00ff00; /* Neon Green Active State */
            background: #051a05;
            border-bottom: 2px solid #00ff00;
        }
       .video-wrapper {
    position: relative;
    width: 100%;
    height: 100%;
    background: #000;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden; /* Prevents sliders from pushing the video */
}

video {
    width: 100% !important;
    height: 100% !important;
    object-fit: cover; /* Ensures video fills the area without zooming out */
    position: absolute;
    top: 0;
    left: 0;
}

#config-overlay, #safety-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100% !important;
    height: 100% !important;
    z-index: 10;
}
        #zone-canvas {
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            cursor: crosshair; 
            z-index: 100 !important; /* Forces it to sit on top of video */
            background: transparent;
        }
        #detect-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 40; }
       #safety-overlay {
    display: block !important; /* Override any hidden styles */
    position: absolute !important;
    top: 0;
    left: 0;
    width: 100% !important;
    height: 100% !important;
    z-index: 9999 !important; /* Sit above the video and everything else */
    pointer-events: none; /* Let clicks pass through to the video if needed */
    overflow: visible !important; /* Ensure the glow isn't clipped */
}

        /* Status Badges - Official Look */
        .status-badge {
            display: inline-flex; items-center; gap: 8px;
            padding: 4px 12px; border: 1px solid #333;
            font-size: 0.7rem; letter-spacing: 0.1em;
            background: #111; color: #888;
        }
        .status-ok { border-color: #064e3b; color: #34d399; background: #022c22; }
       /* Glowing Trip-line Style */
.trip-line-glow {
    filter: drop-shadow(0 0 8px rgba(34, 197, 94, 0.8));
}
    </style>
</head>
<body class="flex flex-col h-screen">

    <header class="h-14 bg-slate-900 border-b border-slate-700 flex justify-between items-center px-4 shrink-0">
        <div class="flex items-center gap-4">
            <div class="text-xl font-bold text-white tracking-tight">
                <i class="fa-solid fa-subway text-sky-500 mr-2"></i>SURVEILLANCE <span class="text-green-500">COMMAND</span>
            </div>
            <div class="h-6 w-px bg-slate-700 mx-2"></div>
            <nav class="flex">
                <button onclick="switchTab('monitor')" id="tab-monitor" class="nav-btn active">
                    <i class="fa-solid fa-eye mr-2"></i>Live Monitor
                </button>
                <button onclick="switchTab('config')" id="tab-config" class="nav-btn">
                    <i class="fa-solid fa-pen-ruler mr-2"></i>Zone Config
                </button>
                <button onclick="switchTab('history')" id="tab-history" class="nav-btn">
                    <i class="fa-solid fa-clock-rotate-left mr-2"></i>History Log
                </button>
                <button onclick="switchTab('register')" id="tab-register" class="nav-btn">
    <i class="fa-solid fa-id-card mr-2"></i>RFID Register
</button>
                <button onclick="checkData()" class="bg-yellow-600 p-2 text-white">DEBUG: Check DB</button>
            </nav>
        </div>
        
        <div class="flex items-center gap-4">
            <div id="connection-status" class="status-badge status-ok">
                <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                SYSTEM ONLINE
            </div>
            <div class="text-xs text-slate-500 font-mono text-right">
                <div id="clock">12:00:00</div>
                <div>CAM-01 [MASTER]</div>
            </div>
        </div>
    </header>

<main class="flex-1 relative overflow-hidden">
    <div id="view-monitor" class="absolute inset-0 grid grid-cols-[1fr_400px]">
        <div class="video-wrapper relative group bg-black flex items-center justify-center">
            <video id="monitor-video" autoplay playsinline muted class="w-full h-full object-contain"></video>
            <svg id="safety-overlay" class="absolute inset-0 w-full h-full pointer-events-none"></svg>
            <div class="absolute top-4 left-4 bg-black/60 backdrop-blur px-3 py-1 rounded border-l-4 border-sky-500 text-xs text-white">
                Monitoring Zone: <span id="zone-status-text" class="text-green-400">ACTIVE</span>
            </div>
        </div>

        <div class="bg-slate-800 border-l border-slate-700 flex flex-col">
            <div class="p-4 bg-slate-900 border-b border-slate-700 flex justify-between items-center">
                <h3 class="font-bold text-white">Live Violations</h3>
                <span class="bg-red-900/50 text-red-400 text-xs px-2 py-1 rounded">Real-time</span>
            </div>
            <div id="alerts-feed" class="flex-1 overflow-y-auto p-4 space-y-3">
                <div class="text-center text-slate-500 mt-10 italic text-sm">System Armed. No violations.</div>
            </div>
        </div>
    </div>

    <div id="view-config" class="absolute inset-0 hidden grid grid-cols-[1fr_350px] bg-slate-900">
        <div class="relative bg-black flex items-center justify-center overflow-hidden">
            <video id="config-video" autoplay playsinline muted class="opacity-50 w-full h-full object-contain"></video>
            <svg id="config-overlay" class="absolute inset-0 w-full h-full pointer-events-none"></svg>
        </div>

        <div class="bg-slate-800 border-l border-slate-700 flex flex-col">
            <div class="p-4 bg-slate-900 border-b border-slate-700">
                <h3 class="font-bold text-white mb-4">Zone Parameters</h3>
                <label class="text-[10px] text-slate-500 block mb-1">CONTROL POINTS (N)</label>
                <input id="pointCount" type="range" min="2" max="10" value="4" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-sky-500">
                <div class="flex justify-between text-sky-400 font-mono text-xs mt-1">
                    <span>2 pts</span>
                    <span id="pointCountLabel">4</span>
                    <span>10 pts</span>
                </div>
            </div>

            <div id="slider-panel" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-800/50">
                </div>

            <div class="p-4 bg-slate-900 border-t border-slate-700 space-y-2">
                <button onclick="saveConfig()" class="w-full bg-green-600 hover:bg-green-500 text-white py-2 rounded font-bold transition">
                    <i class="fa-solid fa-floppy-disk mr-2"></i>SAVE CONFIGURATION
                </button>
            </div>
        </div>
        <div id="safety-side-picker" class="hidden absolute inset-0 bg-black/80 flex items-center justify-center z-[2000]">
    <div class="bg-slate-900 border border-slate-700 p-6 rounded-xl shadow-2xl text-center max-w-sm">
        <i class="fa-solid fa-shield-halved text-4xl text-sky-500 mb-4"></i>
        <h3 class="text-xl font-bold text-white mb-2">Define Safe Zone</h3>
        <p class="text-slate-400 text-sm mb-6">Which side of the green line is the SAFE PLATFORM?</p>
        
        <div class="grid grid-cols-2 gap-4">
            <button onclick="setSafetySide('above')" class="bg-slate-800 hover:bg-sky-900 border border-slate-600 p-4 rounded-lg transition group">
                <div class="text-white font-bold group-hover:text-sky-400">ABOVE / LEFT</div>
                <div class="text-[10px] text-slate-500">Platform is here</div>
            </button>
            <button onclick="setSafetySide('below')" class="bg-slate-800 hover:bg-red-900 border border-slate-600 p-4 rounded-lg transition group">
                <div class="text-white font-bold group-hover:text-red-400">BELOW / RIGHT</div>
                <div class="text-[10px] text-slate-500">Track is here</div>
            </button>
        </div>
    </div>
</div>
    </div>
</main>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBoWtfLODLrDhRKkMew0sLceDgHBNAQAPM",
        projectId: "metro-safety-system",
        databaseURL: "https://metro-safety-system-default-rtdb.firebaseio.com"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- STATE ---
    let controlPoints = [];
    let n = 4;
    let safeSide = 'above';

    // --- INITIALIZE POINTS ---
    function initPoints(count) {
        controlPoints = [];
        for (let i = 0; i < count; i++) {
            controlPoints.push({ 
                x: (i / (count - 1)), 
                y: 0.5 
            });
        }
        renderSliders();
        drawLines();
    }

    // --- RENDER DYNAMIC SLIDERS ---
    function renderSliders() {
        const panel = document.getElementById('slider-panel');
        // We do not clear innerHTML here to prevent slider "flicker" while moving
        // Instead, we update the labels and values if they exist, or build new ones
        panel.innerHTML = '';
        
        controlPoints.forEach((pt, i) => {
            const group = document.createElement('div');
            group.className = "p-3 bg-black/40 border border-slate-700 rounded-lg mb-2";
            group.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <span class="text-green-500 font-bold text-[10px]">POINT ${i + 1}</span>
                    <span class="text-[9px] text-slate-500 font-mono">X: ${Math.round(pt.x*100)}% | Y: ${Math.round(pt.y*100)}%</span>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[9px] text-slate-400 block">HORIZONTAL (X)</label>
                        <input type="range" min="0" max="100" value="${pt.x * 100}" 
                            oninput="window.updatePoint(${i}, 'x', this.value)" 
                            class="w-full h-1 bg-slate-700 appearance-none accent-sky-500">
                    </div>
                    <div>
                        <label class="text-[9px] text-slate-400 block">VERTICAL (Y)</label>
                        <input type="range" min="0" max="100" value="${pt.y * 100}" 
                            oninput="window.updatePoint(${i}, 'y', this.value)" 
                            class="w-full h-1 bg-slate-700 appearance-none accent-red-500">
                    </div>
                </div>
            `;
            panel.appendChild(group);
        });
    }

    // --- CORE DRAWING LOGIC (Fixed for 100% Zoom & Anti-Zigzag) ---
    function drawLines() {
        const overlays = ['safety-overlay', 'config-overlay'];
        
        overlays.forEach(id => {
            const svg = document.getElementById(id);
            if (!svg) return;

            // Anchor drawing to the video's actual client dimensions
            const video = document.getElementById('config-video');
            const w = video.clientWidth || svg.parentElement.clientWidth;
            const h = video.clientHeight || svg.parentElement.clientHeight;

            svg.setAttribute('viewBox', `0 0 ${w} ${h}`);

            if (controlPoints.length < 2) return;

            // Generate SVG Path
            let d = `M ${controlPoints[0].x * w} ${controlPoints[0].y * h}`;
            for (let i = 1; i < controlPoints.length; i++) {
                d += ` L ${controlPoints[i].x * w} ${controlPoints[i].y * h}`;
            }

            svg.innerHTML = `
                <path d="${d}" 
                      stroke="#00ff00" 
                      stroke-width="5" 
                      fill="none" 
                      stroke-linecap="round" 
                      stroke-linejoin="round" 
                      style="filter: drop-shadow(0 0 10px rgba(0,255,0,0.9))" />
                ${controlPoints.map(p => `
                    <circle cx="${p.x * w}" cy="${p.y * h}" r="5" fill="white" stroke="#00ff00" stroke-width="2" />
                `).join('')}
            `;
        });
    }

    // --- EXPOSED WINDOW FUNCTIONS ---
    window.updatePoint = (index, axis, val) => {
        controlPoints[index][axis] = val / 100;
        
        // ANTI-ZIGZAG: Sort points by X so the line always flows left-to-right
        controlPoints.sort((a, b) => a.x - b.x);
        
        // Refresh UI
        drawLines();
        renderSliders(); 
    };

    window.saveConfig = () => {
        if (controlPoints.length < 2) return alert("Define the line first.");
        document.getElementById('safety-side-picker').classList.remove('hidden');
    };

    window.setSafetySide = async (side) => {
        safeSide = side;
        document.getElementById('safety-side-picker').classList.add('hidden');

        try {
            await setDoc(doc(db, "config", "station_settings"), {
                station_id: "STN-01",
                poly_points: controlPoints,
                safe_side: safeSide,
                updated_at: new Date().toISOString()
            });
            alert(`SYSTEM LOCKED: ${side.toUpperCase()} IS SAFE`);
            window.switchTab('monitor');
        } catch (e) { alert("Sync Error: " + e.message); }
    };

    window.switchTab = (tab) => {
        document.getElementById('view-monitor').classList.toggle('hidden', tab !== 'monitor');
        document.getElementById('view-config').classList.toggle('hidden', tab !== 'config');
        document.getElementById('tab-monitor').classList.toggle('active', tab === 'monitor');
        document.getElementById('tab-config').classList.toggle('active', tab === 'config');
        setTimeout(drawLines, 50);
    };

    // --- INITIALIZATION ---
    document.getElementById('pointCount').oninput = (e) => {
        n = parseInt(e.target.value);
        document.getElementById('pointCountLabel').innerText = n;
        initPoints(n);
    };

    window.addEventListener('resize', drawLines);
    initPoints(4); 

    navigator.mediaDevices.getUserMedia({ video: true }).then(s => {
        document.getElementById('monitor-video').srcObject = s;
        document.getElementById('config-video').srcObject = s;
    });

    const resizeObserver = new ResizeObserver(() => drawLines());
    document.querySelectorAll('.video-wrapper').forEach(div => resizeObserver.observe(div));
</script>
    <script src="https://cdn.tailwindcss.com"></script>
</body>
</html>
