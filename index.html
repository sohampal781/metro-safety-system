<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metro Safety | Station Master Command Console</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --neon-green: #00ff00; --danger-red: rgba(220, 38, 38, 0.4); --terminal-black: #050505; }
        body { background-color: #000; color: #ccc; overflow: hidden; font-family: 'Courier New', monospace; text-transform: uppercase; }
        
        /* Industrial Navigation */
        .nav-btn { padding: 14px 28px; border-right: 1px solid #222; color: #555; font-weight: 800; background: #000; cursor: pointer; transition: all 0.3s ease; letter-spacing: 1px; }
        .nav-btn:hover { color: #fff; background: #111; }
        .nav-btn.active { color: var(--neon-green); background: #051a05; border-bottom: 3px solid var(--neon-green); }

        /* Video & Canvas Overlay Layering */
        .viewport-container { position: relative; width: 100%; height: 100%; background: #000; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 1px solid #111; }
        video { width: 100% !important; height: 100% !important; object-fit: cover; position: absolute; top: 0; left: 0; z-index: 1; }
        svg { position: absolute; inset: 0; width: 100% !important; height: 100% !important; z-index: 10; pointer-events: none; }

        /* Sidebar Control Panel */
        #slider-panel { display: block; overflow-y: auto; max-height: calc(100vh - 250px); padding-right: 10px; }
        #slider-panel::-webkit-scrollbar { width: 4px; }
        #slider-panel::-webkit-scrollbar-track { background: #0a0a0a; }
        #slider-panel::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        #slider-panel::-webkit-scrollbar-thumb:hover { background: var(--neon-green); }

        /* Violation UI */
        .unsafe-overlay-tint { fill: var(--danger-red); transition: opacity 0.5s ease; }
        .violation-card { background: rgba(15, 15, 15, 0.9); border-left: 4px solid #dc2626; animation: alert-pulse 2s infinite; }
        @keyframes alert-pulse { 0% { border-color: #dc2626; } 50% { border-color: #450a0a; } 100% { border-color: #dc2626; } }

        /* Industrial Scoping */
        .status-indicator { display: inline-flex; align-items: center; gap: 8px; font-size: 10px; color: #666; }
        .status-online { color: var(--neon-green); }
    </style>
</head>
<body class="flex flex-col h-screen">

    <header class="h-16 bg-slate-900 border-b border-slate-700 flex justify-between items-center px-6 shrink-0 z-50">
        <div class="flex items-center gap-8">
            <div class="flex flex-col">
                <span class="text-xl font-black text-white tracking-tighter">
                    <i class="fa-solid fa-subway text-sky-500 mr-2"></i>METRO-SAFETY <span class="text-green-500">v4.0</span>
                </span>
                <span class="text-[9px] text-slate-500 font-mono">STATION MASTER COMMAND INTERFACE</span>
            </div>
            <nav class="flex h-16">
                <button onclick="window.switchTab('monitor')" id="tab-monitor" class="nav-btn active">LIVE MONITOR</button>
                <button onclick="window.switchTab('config')" id="tab-config" class="nav-btn">ZONE CALIBRATION</button>
                <button onclick="window.switchTab('prosecute')" id="tab-prosecute" class="nav-btn">PROSECUTION LOG</button>
            </nav>
        </div>
        
        <div class="flex items-center gap-6 font-mono">
            <div class="text-right">
                <div id="clock" class="text-sm text-white font-bold">00:00:00</div>
                <div class="status-indicator status-online"><i class="fa-solid fa-circle text-[6px]"></i> SYSTEM ENCRYPTED</div>
            </div>
            <div class="h-10 w-px bg-slate-800"></div>
            <div class="text-[10px] text-slate-500">CAM_ID: 01-MASTER<br>AUTH: MASTER_USER</div>
        </div>
    </header>

    <main class="flex-1 relative overflow-hidden bg-black">
        
        <div id="view-monitor" class="absolute inset-0 grid grid-cols-[1fr_420px] transition-all duration-500">
            <div class="viewport-container border-r border-slate-800">
                <video id="monitor-video" autoplay playsinline muted></video>
                <svg id="safety-overlay"></svg>
                
                <div class="absolute top-6 left-6 z-20 flex flex-col gap-2">
                    <div class="bg-black/60 backdrop-blur-md px-4 py-2 border-l-2 border-sky-500 text-[10px] text-white">
                        <span class="text-slate-400">STATUS:</span> <span id="sys-status">MONITORING</span>
                    </div>
                    <div class="bg-black/60 backdrop-blur-md px-4 py-2 border-l-2 border-green-500 text-[10px] text-white">
                        <span class="text-slate-400">ZONE:</span> <span id="active-side-display">LEFT SAFE</span>
                    </div>
                </div>

                <button onclick="window.triggerFaceCapture('MASTER_MANUAL')" class="absolute bottom-8 right-8 bg-red-600 hover:bg-red-700 text-white w-16 h-16 rounded-full z-50 shadow-[0_0_20px_rgba(220,38,38,0.5)] transition-transform active:scale-95 flex items-center justify-center">
                    <i class="fa-solid fa-camera text-2xl"></i>
                </button>
            </div>

            <div class="bg-slate-900 flex flex-col">
                <div class="p-4 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
                    <h3 class="font-bold text-white text-xs tracking-widest">LIVE INTRUSION ALERTS</h3>
                    <span class="text-[10px] text-red-500 animate-pulse font-bold">REAL-TIME</span>
                </div>
                <div id="alerts-feed" class="flex-1 overflow-y-auto p-4 space-y-4">
                    <div class="h-full flex flex-col items-center justify-center text-slate-600 italic text-sm">
                        <i class="fa-solid fa-shield-halved text-4xl mb-4 opacity-20"></i>
                        Zone Secured.
                    </div>
                </div>
            </div>
        </div>

        <div id="view-config" class="absolute inset-0 hidden grid grid-cols-[1fr_380px] bg-slate-950">
            <div class="viewport-container">
                <video id="config-video" autoplay playsinline muted class="opacity-40"></video>
                <svg id="config-overlay"></svg>
            </div>
            
            <div class="bg-slate-900 border-l border-slate-700 p-6 flex flex-col shadow-2xl">
                <h3 class="text-white font-bold mb-6 flex items-center gap-2">
                    <i class="fa-solid fa-sliders text-sky-500"></i> ZONE CALIBRATION
                </h3>
                
                <div class="space-y-6 flex-1 flex flex-col">
                    <div class="bg-black/40 p-4 rounded-lg border border-slate-800">
                        <label class="text-[10px] text-slate-500 block mb-3 font-bold">NODE DENSITY (2-10)</label>
                        <input id="pointCount" type="range" min="2" max="10" value="4" class="w-full h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-sky-500">
                        <div class="flex justify-between text-sky-500 font-mono text-[10px] mt-2">
                            <span>MIN_RES</span>
                            <span id="pointCountLabel" class="text-white bg-sky-600 px-2 rounded">4</span>
                            <span>MAX_RES</span>
                        </div>
                    </div>

                    <div id="slider-panel" class="flex-1 pr-2">
                        </div>
                </div>

                <button onclick="window.saveConfig()" class="w-full bg-green-600 hover:bg-green-500 text-white py-4 rounded font-black tracking-widest transition-all shadow-lg mt-4">
                    COMMIT ZONE TO DATABASE
                </button>
            </div>
        </div>

        <div id="view-prosecute" class="absolute inset-0 hidden bg-slate-950 p-8 overflow-y-auto">
            <div class="max-w-7xl mx-auto">
                <div class="flex justify-between items-end border-b border-slate-800 pb-6 mb-8">
                    <div>
                        <h2 class="text-2xl font-black text-white tracking-tighter">PROSECUTION RECORDS</h2>
                        <p class="text-slate-500 text-xs mt-1 font-mono text-uppercase">Centralized Intrusion Database / Authorized Access Only</p>
                    </div>
                    <div class="flex gap-4">
                        <div class="bg-slate-900 px-4 py-2 border border-slate-800 text-[10px]">
                            <span class="text-slate-500">TOTAL RECORDS:</span> <span id="record-count" class="text-white">0</span>
                        </div>
                    </div>
                </div>
                
                <div id="prosecution-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    </div>
            </div>
        </div>

        <div id="safety-side-picker" class="hidden absolute inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center z-[2000]">
            <div class="bg-slate-900 border border-slate-700 p-10 rounded-2xl shadow-2xl text-center max-w-lg w-full">
                <div class="text-sky-500 mb-4 font-black tracking-[0.3em] text-[10px]">SYSTEM CALIBRATION</div>
                <h3 class="text-2xl font-bold text-white mb-8">WHICH SEGMENT IS SAFE?</h3>
                
                <div class="grid grid-cols-2 gap-6">
                    <button onclick="window.setSafetySide('left')" class="bg-slate-800 hover:bg-green-900/40 border-2 border-slate-700 hover:border-green-500 p-8 rounded-xl transition-all group">
                        <i class="fa-solid fa-arrow-left text-3xl text-slate-600 group-hover:text-green-500 mb-4 block"></i>
                        <span class="text-white font-bold block">LEFT SIDE</span>
                        <span class="text-[9px] text-slate-500">PLATFORM AREA</span>
                    </button>
                    <button onclick="window.setSafetySide('right')" class="bg-slate-800 hover:bg-green-900/40 border-2 border-slate-700 hover:border-green-500 p-8 rounded-xl transition-all group">
                        <i class="fa-solid fa-arrow-right text-3xl text-slate-600 group-hover:text-green-500 mb-4 block"></i>
                        <span class="text-white font-bold block">RIGHT SIDE</span>
                        <span class="text-[9px] text-slate-500">PLATFORM AREA</span>
                    </button>
                </div>
                <button onclick="document.getElementById('safety-side-picker').classList.add('hidden')" class="mt-8 text-slate-600 hover:text-white text-[10px] underline tracking-widest">ABORT CONFIGURATION</button>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getFirestore, doc, setDoc, collection, query, orderBy, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

        // Firebase Configuration
        const firebaseConfig = { 
            apiKey: "AIzaSyBoWtfLODLrDhRKkMew0sLceDgHBNAQAPM", 
            projectId: "metro-safety-system", 
            databaseURL: "https://metro-safety-system-default-rtdb.firebaseio.com" 
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // State Machine
        let controlPoints = [];
        let nodeCount = 4;
        let safeSide = 'left';
        let isSystemReady = false;

        /**
         * 1. COORDINATE SYSTEM & INTERPOLATION ENGINE
         * Based on the user's station logging interest
         */
        window.isUnsafe = (personX, personY) => {
            if (controlPoints.length < 2) return false;
            
            // Linear Interpolation for Polyline Segments
            for (let i = 0; i < controlPoints.length - 1; i++) {
                const p1 = controlPoints[i];
                const p2 = controlPoints[i+1];
                
                // Check if person X falls within this line segment
                if (personX >= Math.min(p1.x, p2.x) && personX <= Math.max(p1.x, p2.x)) {
                    // Standard linear interpolation formula: y = y1 + ((y2 - y1) / (x2 - x1)) * (x - x1)
                    const lineY = p1.y + ((p2.y - p1.y) / (p2.x - p1.x)) * (personX - p1.x);
                    
                    // Violation logic based on safe side preference
                    if (safeSide === 'left') {
                        return personX > p1.x; // Simplified for vertical-ish lines
                    } else {
                        return personX < p1.x;
                    }
                }
            }
            return false;
        };

        /**
         * 2. DETECTION HOOK (FOR AI INTEGRATION)
         */
        window.processDetection = (normX, normY) => {
            if (window.isUnsafe(normX, normY)) {
                console.warn("ALARM: Tripwire Breach at", normX, normY);
                window.triggerFaceCapture('AUTO_INTRUSION_DETECT');
            }
        };

        /**
         * 3. MASTER CAPTURE ENGINE
         * Captures 100% zoom frame and uploads to Firestore
         */
        window.triggerFaceCapture = async (reasonCode) => {
            const videoSource = document.getElementById('monitor-video');
            if (!videoSource || videoSource.readyState < 2) return;

            const offscreenCanvas = document.createElement('canvas');
            offscreenCanvas.width = videoSource.videoWidth;
            offscreenCanvas.height = videoSource.videoHeight;
            
            const context = offscreenCanvas.getContext('2d');
            context.drawImage(videoSource, 0, 0, offscreenCanvas.width, offscreenCanvas.height);
            
            const blobData = offscreenCanvas.toDataURL('image/jpeg', 0.7);
            const recordUid = `RECORD_${Date.now()}`;

            try {
                // Atomic save to violations collection
                await setDoc(doc(db, "violations", recordUid), {
                    timestamp: new Date().toISOString(),
                    image_base64: blobData,
                    trigger_type: reasonCode,
                    station_id: "HOWRAH_STN_01",
                    status: "ACTIVE_PROSECUTION"
                });
                console.log("Success: Record created", recordUid);
            } catch (err) {
                console.error("Critical: Firestore Sync Error", err);
            }
        };

        /**
         * 4. CRUD OPERATIONS: DELETE
         */
        window.deleteRecord = async (docId) => {
            if (confirm("Confirm permanent deletion of prosecution record? This cannot be undone.")) {
                try {
                    await deleteDoc(doc(db, "violations", docId));
                    console.log("Deleted:", docId);
                } catch (err) {
                    alert("Delete failed: " + err.message);
                }
            }
        };

        /**
         * 5. UI: POLYGON & TINT RENDERING
         */
        window.drawLines = () => {
            const targets = ['safety-overlay', 'config-overlay'];
            targets.forEach(svgId => {
                const svgElement = document.getElementById(svgId);
                const referenceVideo = document.getElementById('config-video');
                const width = referenceVideo.clientWidth || svgElement.parentElement.clientWidth;
                const height = referenceVideo.clientHeight || svgElement.parentElement.clientHeight;
                
                if (!svgElement || width === 0) return;
                svgElement.setAttribute('viewBox', `0 0 ${width} ${height}`);

                if (controlPoints.length < 2) return;

                // Build Path Data
                let pathString = `M ${controlPoints[0].x * width} ${controlPoints[0].y * height}`;
                for (let j = 1; j < controlPoints.length; j++) {
                    pathString += ` L ${controlPoints[j].x * width} ${controlPoints[j].y * height}`;
                }

                // Shading the Unsafe Zone
                let shadePath = pathString;
                if (safeSide === 'left') {
                    // Safe=Left, Tint=Right
                    shadePath += ` L ${width} ${controlPoints[nodeCount - 1].y * height} L ${width} ${height} L 0 ${height} L 0 ${controlPoints[0].y * height} Z`;
                } else {
                    // Safe=Right, Tint=Left
                    shadePath += ` L 0 ${controlPoints[nodeCount - 1].y * height} L 0 ${height} L ${width} ${height} L ${width} ${controlPoints[0].y * height} Z`;
                }

                svgElement.innerHTML = `
                    <path d="${shadePath}" class="unsafe-overlay-tint" />
                    <path d="${pathString}" stroke="#00ff00" stroke-width="4" fill="none" stroke-linecap="round" />
                    ${svgId === 'config-overlay' ? controlPoints.map((p, idx) => `
                        <circle cx="${p.x * width}" cy="${p.y * height}" r="6" fill="#fff" stroke="#00ff00" stroke-width="2" />
                        <text x="${p.x * width + 10}" y="${p.y * height - 10}" fill="#00ff00" font-size="10" font-weight="bold">${idx + 1}</text>
                    `).join('') : ''}
                `;
            });
        };

        /**
         * 6. INDEPENDENT SLIDER CONTROLS
         */
        window.updatePoint = (index, axis, value) => {
            controlPoints[index][axis] = value / 100;
            const labelElements = document.querySelectorAll('.pos-label');
            if (labelElements[index]) {
                labelElements[index].innerText = `X:${Math.round(controlPoints[index].x * 100)}% Y:${Math.round(controlPoints[index].y * 100)}%`;
            }
            window.drawLines();
        };

        window.renderSliders = () => {
            const panel = document.getElementById('slider-panel');
            panel.innerHTML = '';
            controlPoints.forEach((pt, i) => {
                const group = document.createElement('div');
                group.className = "p-4 bg-black/60 border border-slate-800 rounded-xl mb-4 hover:border-sky-900 transition-colors";
                group.innerHTML = `
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-sky-500 font-black text-[10px] tracking-widest">NODE ${i + 1}</span>
                        <span class="pos-label text-[9px] text-slate-500 font-mono">X:${Math.round(pt.x * 100)}% Y:${Math.round(pt.y * 100)}%</span>
                    </div>
                    <div class="space-y-4">
                        <div class="flex items-center gap-3">
                            <span class="text-[8px] text-slate-600 w-4">X</span>
                            <input type="range" min="0" max="100" value="${pt.x * 100}" oninput="window.updatePoint(${i}, 'x', this.value)" class="flex-1 h-1 bg-slate-800 rounded-lg appearance-none accent-sky-500 cursor-pointer">
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="text-[8px] text-slate-600 w-4">Y</span>
                            <input type="range" min="0" max="100" value="${pt.y * 100}" oninput="window.updatePoint(${i}, 'y', this.value)" class="flex-1 h-1 bg-slate-800 rounded-lg appearance-none accent-red-600 cursor-pointer">
                        </div>
                    </div>`;
                panel.appendChild(group);
            });
        };

        /**
         * 7. MASTER DATABASE REAL-TIME LISTENERS
         */
        window.initListeners = () => {
            const q = query(collection(db, "violations"), orderBy("timestamp", "desc"));
            
            onSnapshot(q, (snapshot) => {
                const list = document.getElementById('prosecution-list');
                const feed = document.getElementById('alerts-feed');
                const countBadge = document.getElementById('record-count');
                
                if (list) list.innerHTML = "";
                if (feed) feed.innerHTML = "";
                if (countBadge) countBadge.innerText = snapshot.size;

                if (snapshot.empty && feed) {
                    feed.innerHTML = `<div class="h-full flex flex-col items-center justify-center text-slate-600 italic text-sm">Zone Secured.</div>`;
                }

                snapshot.forEach(snap => {
                    const data = snap.data();
                    
                    // Create Master Log Card
                    const logCard = document.createElement('div');
                    logCard.className = "bg-slate-900 border border-slate-800 rounded-xl overflow-hidden shadow-2xl hover:border-red-900 transition-all group";
                    logCard.innerHTML = `
                        <div class="relative">
                            <img src="${data.image_base64}" class="w-full h-44 object-cover">
                            <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent"></div>
                            <div class="absolute bottom-3 left-3 text-[9px] text-white font-black">${data.trigger_type}</div>
                        </div>
                        <div class="p-4">
                            <div class="flex justify-between text-[9px] text-slate-500 mb-4 font-mono">
                                <span>ID: ${snap.id.substring(0,8)}</span>
                                <span>${new Date(data.timestamp).toLocaleString()}</span>
                            </div>
                            <button onclick="window.deleteRecord('${snap.id}')" class="w-full bg-red-900/20 hover:bg-red-600 text-red-500 hover:text-white py-3 text-[10px] font-black transition-all rounded-lg border border-red-900/50">
                                PURGE FROM DATABASE
                            </button>
                        </div>`;
                    
                    if (list) list.appendChild(logCard);

                    // Add to Monitoring Sidebar Feed
                    if (feed) {
                        const miniCard = document.createElement('div');
                        miniCard.className = "violation-card p-3 rounded-lg flex gap-3 items-center";
                        miniCard.innerHTML = `
                            <img src="${data.image_base64}" class="w-16 h-16 rounded object-cover border border-red-900">
                            <div>
                                <div class="text-[9px] font-black text-red-500">BREACH DETECTED</div>
                                <div class="text-[8px] text-slate-400 font-mono">${new Date(data.timestamp).toLocaleTimeString()}</div>
                                <button onclick="window.switchTab('prosecute')" class="text-[8px] text-sky-500 underline mt-1">VIEW PROSECUTION</button>
                            </div>`;
                        feed.appendChild(miniCard);
                    }
                });
            });
        };

        /**
         * 8. SYSTEM INITIALIZATION & ORCHESTRATION
         */
        window.startCamera = async () => {
            const monitor = document.getElementById('monitor-video');
            const config = document.getElementById('config-video');
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 1280, height: 720, frameRate: 30 } 
                });
                monitor.srcObject = stream;
                config.srcObject = stream;
                console.log("System: Optical Stream Active");
            } catch (err) {
                console.error("Critical: Camera Access Denied", err);
                document.querySelectorAll('.viewport-container').forEach(c => c.classList.add('camera-error'));
            }
        };

        window.switchTab = (target) => {
            document.querySelectorAll('main > div').forEach(div => div.classList.add('hidden'));
            document.getElementById(`view-${target}`).classList.remove('hidden');
            
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tab-${target}`).classList.add('active');
            
            // Re-sync drawing on tab switch
            setTimeout(window.drawLines, 50);
        };

        window.saveConfig = () => document.getElementById('safety-side-picker').classList.remove('hidden');

        window.setSafetySide = async (choice) => {
            safeSide = choice;
            window.drawLines();
            document.getElementById('active-side-display').innerText = `${choice.toUpperCase()} SAFE`;
            try {
                // Persistent station settings storage
                await setDoc(doc(db, "config", "station_settings"), {
                    poly_points: controlPoints,
                    safe_platform_side: safeSide,
                    calibration_date: new Date().toISOString()
                });
                document.getElementById('safety-side-picker').classList.add('hidden');
                window.switchTab('monitor');
            } catch (err) { alert("Sync Failed: " + err.message); }
        };

        // --- EXECUTION ---
        
        // Handle node density change
        document.getElementById('pointCount').oninput = (e) => {
            nodeCount = parseInt(e.target.value);
            document.getElementById('pointCountLabel').innerText = nodeCount;
            // Initialize points in a straight horizontal line as baseline
            controlPoints = Array.from({length: nodeCount}, (_, i) => ({ 
                x: i / (nodeCount - 1), 
                y: 0.5 
            }));
            window.renderSliders();
            window.drawLines();
        };

        // Global Clock
        setInterval(() => {
            document.getElementById('clock').innerText = new Date().toLocaleTimeString();
        }, 1000);

        // Bootstrap Sequence
        window.startCamera();
        window.initListeners();
        
        // Default 4-point initialization
        controlPoints = Array.from({length: 4}, (_, i) => ({ x: i / 3, y: 0.5 }));
        window.renderSliders();
        
        // Resize Observer for HUD alignment
        const resizeObserver = new ResizeObserver(() => window.drawLines());
        document.querySelectorAll('.viewport-container').forEach(v => resizeObserver.observe(v));
        
        // Final Draw Sync
        setTimeout(window.drawLines, 1000);
        
    </script>
</body>
</html>
