<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metro Safety | Station Master Console</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #000; color: #ccc; overflow: hidden; font-family: 'Courier New', monospace; text-transform: uppercase; }
        .nav-btn { padding: 12px 24px; border-right: 1px solid #222; color: #555; font-weight: bold; background: #000; cursor: pointer; }
        .nav-btn.active { color: #0f0; background: #051a05; border-bottom: 2px solid #0f0; }
        .video-wrapper { position: relative; width: 100%; height: 100%; background: #000; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        video { width: 100% !important; height: 100% !important; object-fit: cover; position: absolute; }
        svg { position: absolute; inset: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        #slider-panel { display: block; overflow-y: auto; max-height: calc(100vh - 220px); padding-bottom: 40px; }
        .unsafe-overlay-tint { fill: rgba(220, 38, 38, 0.4); }
        .camera-error { background: repeating-linear-gradient(45deg, #000, #000 10px, #111 10px, #111 20px); display: flex; align-items: center; justify-content: center; color: #333; }
    </style>
</head>
<body class="flex flex-col h-screen">

    <header class="h-14 bg-black border-b border-slate-700 flex justify-between items-center px-4">
        <div class="flex items-center gap-4">
            <div class="text-xl font-bold text-white"><i class="fa-solid fa-subway text-sky-500 mr-2"></i>SURVEILLANCE <span class="text-green-500">COMMAND</span></div>
            <nav class="flex">
                <button onclick="window.switchTab('monitor')" id="tab-monitor" class="nav-btn active">MONITOR</button>
                <button onclick="window.switchTab('config')" id="tab-config" class="nav-btn">CONFIG</button>
                <button onclick="window.switchTab('prosecute')" id="tab-prosecute" class="nav-btn">PROSECUTION</button>
            </nav>
        </div>
        <div id="clock" class="text-xs font-mono">12:00:00</div>
    </header>

    <main class="flex-1 relative overflow-hidden">
        <div id="view-monitor" class="absolute inset-0 grid grid-cols-[1fr_400px]">
            <div class="video-wrapper">
                <video id="monitor-video" autoplay playsinline muted></video>
                <svg id="safety-overlay"></svg>
                <button onclick="window.triggerFaceCapture('MANUAL_SNAP')" class="absolute bottom-6 right-6 bg-red-600 text-white p-4 rounded-full z-50 shadow-xl"><i class="fa-solid fa-camera"></i></button>
            </div>
            <div class="bg-slate-900 border-l border-slate-700 p-4 overflow-y-auto" id="alerts-feed"></div>
        </div>

        <div id="view-config" class="absolute inset-0 hidden grid grid-cols-[1fr_350px]">
            <div class="video-wrapper">
                <video id="config-video" autoplay playsinline muted class="opacity-50"></video>
                <svg id="config-overlay"></svg>
            </div>
            <div class="bg-slate-900 border-l border-slate-700 p-4 flex flex-col">
                <h3 class="font-bold mb-4">ZONE PARAMETERS</h3>
                <input id="pointCount" type="range" min="2" max="10" value="4" class="w-full mb-4">
                <div id="slider-panel" class="flex-1"></div>
                <button onclick="window.saveConfig()" class="w-full bg-green-600 py-3 rounded font-bold mt-4">LOCK ZONE</button>
            </div>
        </div>

        <div id="view-prosecute" class="absolute inset-0 hidden bg-black p-6 overflow-y-auto">
            <h2 class="text-xl font-bold mb-6">PROSECUTION LOG</h2>
            <div id="prosecution-list" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>
        </div>

        <div id="safety-side-picker" class="hidden absolute inset-0 bg-black/80 flex items-center justify-center z-[2000]">
            <div class="bg-slate-900 p-8 rounded-xl text-center border border-slate-700">
                <h3 class="mb-6 font-bold">WHICH SIDE IS SAFE?</h3>
                <div class="flex gap-4">
                    <button onclick="window.setSafetySide('left')" class="p-6 bg-slate-800 rounded-lg border border-slate-600">LEFT</button>
                    <button onclick="window.setSafetySide('right')" class="p-6 bg-slate-800 rounded-lg border border-slate-600">RIGHT</button>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getFirestore, doc, setDoc, collection, query, orderBy, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBoWtfLODLrDhRKkMew0sLceDgHBNAQAPM", projectId: "metro-safety-system" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let controlPoints = [];
        let n = 4;
        let sidePreference = 'left';

        // Math & Detection
        window.isUnsafe = (pX, pY) => {
            if (!controlPoints.length) return false;
            return sidePreference === 'left' ? pX > controlPoints[0].x : pX < controlPoints[0].x;
        };

        window.processDetection = (x, y) => {
            if (window.isUnsafe(x, y)) window.triggerFaceCapture('AUTO_DETECTION');
        };

        // Capture & Database
        window.triggerFaceCapture = async (type) => {
            const video = document.getElementById('monitor-video');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            const img = canvas.toDataURL('image/jpeg', 0.6);
            try {
                await setDoc(doc(db, "violations", `V-${Date.now()}`), { timestamp: new Date().toISOString(), image_data: img, type: type });
            } catch (e) { console.error(e); }
        };

        window.deleteRecord = async (id) => {
            if(confirm("Delete record?")) await deleteDoc(doc(db, "violations", id));
        };

        // UI Drawing
        window.drawLines = () => {
            const overlays = ['safety-overlay', 'config-overlay'];
            overlays.forEach(id => {
                const svg = document.getElementById(id);
                const video = document.getElementById('config-video');
                const w = video.clientWidth; const h = video.clientHeight;
                if (!svg || !w) return;
                svg.setAttribute('viewBox', `0 0 ${w} ${h}`);
                let d = `M ${controlPoints[0].x * w} ${controlPoints[0].y * h}`;
                for (let i = 1; i < controlPoints.length; i++) d += ` L ${controlPoints[i].x * w} ${controlPoints[i].y * h}`;
                let shade = d;
                if (sidePreference === 'left') shade += ` L ${w} ${controlPoints[controlPoints.length-1].y*h} L ${w} ${h} L 0 ${h} L 0 ${controlPoints[0].y*h} Z`;
                else shade += ` L 0 ${controlPoints[controlPoints.length-1].y*h} L 0 ${h} L ${w} ${h} L ${w} ${controlPoints[0].y*h} Z`;
                svg.innerHTML = `<path d="${shade}" class="unsafe-overlay-tint"/><path d="${d}" stroke="#0f0" stroke-width="5" fill="none"/>`;
            });
        }

        window.updatePoint = (i, axis, val) => {
            controlPoints[i][axis] = val / 100;
            const labels = document.querySelectorAll('.pos-label');
            if(labels[i]) labels[i].innerText = `X:${Math.round(controlPoints[i].x*100)}% Y:${Math.round(controlPoints[i].y*100)}%`;
            window.drawLines();
        };

        window.renderSliders = () => {
            const panel = document.getElementById('slider-panel');
            panel.innerHTML = '';
            controlPoints.forEach((pt, i) => {
                const div = document.createElement('div');
                div.className = "p-3 bg-white/5 border border-white/10 rounded mb-3";
                div.innerHTML = `<div class="flex justify-between text-[10px] mb-2"><span class="text-green-500">PT ${i+1}</span><span class="pos-label">X:${Math.round(pt.x*100)}% Y:${Math.round(pt.y*100)}%</span></div>
                <input type="range" min="0" max="100" value="${pt.x*100}" oninput="window.updatePoint(${i}, 'x', this.value)" class="w-full h-1 accent-sky-500 mb-2">
                <input type="range" min="0" max="100" value="${pt.y*100}" oninput="window.updatePoint(${i}, 'y', this.value)" class="w-full h-1 accent-red-500">`;
                panel.appendChild(div);
            });
        }

        // Camera & Listeners
        window.startCamera = async () => {
            try {
                const s = await navigator.mediaDevices.getUserMedia({ video: true });
                document.getElementById('monitor-video').srcObject = s;
                document.getElementById('config-video').srcObject = s;
            } catch (e) { document.querySelectorAll('.video-wrapper').forEach(v => v.classList.add('camera-error')); }
        }

        window.startListeners = () => {
            onSnapshot(query(collection(db, "violations"), orderBy("timestamp", "desc")), (snap) => {
                const list = document.getElementById('prosecution-list');
                const feed = document.getElementById('alerts-feed');
                if(list) list.innerHTML = ""; 
                if(feed) feed.innerHTML = "";
                snap.forEach(doc => {
                    const d = doc.data();
                    const card = document.createElement('div');
                    card.className = "bg-slate-800 border border-slate-700 rounded overflow-hidden mb-3";
                    card.innerHTML = `<img src="${d.image_data}" class="w-full h-32 object-cover"><div class="p-2"><div class="flex justify-between text-[10px] mb-2"><span>${d.type}</span><span>${new Date(d.timestamp).toLocaleTimeString()}</span></div>
                    <button onclick="window.deleteRecord('${doc.id}')" class="w-full bg-red-900/40 py-1 text-[10px]">DELETE</button></div>`;
                    if(list) list.appendChild(card);
                    if(feed) feed.appendChild(card.cloneNode(true));
                });
            });
        }

        // System Control
        window.saveConfig = () => document.getElementById('safety-side-picker').classList.remove('hidden');
        window.setSafetySide = (s) => { sidePreference = s; window.drawLines(); document.getElementById('safety-side-picker').classList.add('hidden'); window.switchTab('monitor'); };
        window.switchTab = (t) => {
            document.querySelectorAll('main > div').forEach(d => d.classList.add('hidden'));
            document.getElementById(`view-${t}`).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${t}`).classList.add('active');
            setTimeout(window.drawLines, 50);
        };

        document.getElementById('pointCount').oninput = (e) => { 
            n = parseInt(e.target.value); 
            document.getElementById('pointCountLabel').innerText = n;
            controlPoints = Array.from({length: n}, (_, i) => ({ x: i/(n-1), y: 0.5 })); 
            window.renderSliders(); 
            window.drawLines(); 
        };
        
        setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString(); }, 1000);
        
        // Start Services
        window.startCamera();
        window.startListeners();
        controlPoints = Array.from({length: 4}, (_, i) => ({ x: i/3, y: 0.5 }));
        window.renderSliders();
        setTimeout(window.drawLines, 500);

        const resizeObserver = new ResizeObserver(() => window.drawLines());
        document.querySelectorAll('.video-wrapper').forEach(div => resizeObserver.observe(div));
    </script>
</body>
</html>
