<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metro Safety | Station Master Console</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #000000; color: #cccccc; overflow: hidden; font-family: 'Courier New', monospace; text-transform: uppercase; }
        .bg-slate-900, .bg-slate-800 { background-color: #0a0a0a !important; border-color: #333 !important; }
        .nav-btn { padding: 12px 24px; border-right: 1px solid #222; color: #555; font-weight: bold; background: #000; cursor: pointer; transition: 0.2s; }
        .nav-btn.active { color: #00ff00; background: #051a05; border-bottom: 2px solid #00ff00; }
        
        .video-wrapper { position: relative; width: 100%; height: 100%; background: #000; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        video { width: 100% !important; height: 100% !important; object-fit: cover; position: absolute; top: 0; left: 0; }
        svg { position: absolute; top: 0; left: 0; width: 100% !important; height: 100% !important; z-index: 10; pointer-events: none; }

        /* Independent Sidebar Scrolling Fix */
        #slider-panel { display: block !important; overflow-y: auto !important; max-height: calc(100vh - 220px); padding-bottom: 40px; }
        #slider-panel::-webkit-scrollbar { width: 6px; }
        #slider-panel::-webkit-scrollbar-track { background: #0a0a0a; }
        #slider-panel::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        #slider-panel::-webkit-scrollbar-thumb:hover { background: #00ff00; }

        .unsafe-overlay-tint { fill: rgba(220, 38, 38, 0.4); pointer-events: none; }
        .camera-error { background: repeating-linear-gradient(45deg, #000, #000 10px, #050505 10px, #050505 20px); display: flex; align-items: center; justify-content: center; color: #333; font-size: 10px; }
    </style>
</head>
<body class="flex flex-col h-screen">

    <header class="h-14 bg-slate-900 border-b border-slate-700 flex justify-between items-center px-4 shrink-0">
        <div class="flex items-center gap-4">
            <div class="text-xl font-bold text-white tracking-tight">
                <i class="fa-solid fa-subway text-sky-500 mr-2"></i>SURVEILLANCE <span class="text-green-500">COMMAND</span>
            </div>
            <nav class="flex">
                <button onclick="switchTab('monitor')" id="tab-monitor" class="nav-btn active">LIVE MONITOR</button>
                <button onclick="switchTab('config')" id="tab-config" class="nav-btn">ZONE CONFIG</button>
            </nav>
        </div>
        <div class="text-xs text-slate-500 font-mono text-right">
            <div id="clock">12:00:00</div>
            <div>CAM-01 [MASTER]</div>
        </div>
    </header>

    <main class="flex-1 relative overflow-hidden">
        <div id="view-monitor" class="absolute inset-0 grid grid-cols-[1fr_400px]">
            <div class="video-wrapper">
                <video id="monitor-video" autoplay playsinline muted></video>
                <svg id="safety-overlay"></svg>
            </div>
            <div class="bg-slate-800 border-l border-slate-700 flex flex-col p-4">
                <h3 class="font-bold text-white border-b border-slate-700 pb-2 mb-4 text-sm">MASTER VIOLATION FEED</h3>
                <div id="alerts-feed" class="flex-1 overflow-y-auto space-y-3">
                    <div class="text-center text-slate-500 mt-10 italic text-sm">System Armed. No violations.</div>
                </div>
            </div>
        </div>

        <div id="view-config" class="absolute inset-0 hidden grid grid-cols-[1fr_350px] bg-slate-900">
            <div class="video-wrapper relative">
                <video id="config-video" autoplay playsinline muted class="opacity-50"></video>
                <svg id="config-overlay"></svg>
            </div>
            <div class="bg-slate-800 border-l border-slate-700 flex flex-col p-4">
                <h3 class="font-bold text-white mb-4 text-sm">ZONE PARAMETERS</h3>
                <label class="text-[10px] text-slate-500 block mb-1">CONTROL POINTS (N)</label>
                <input id="pointCount" type="range" min="2" max="10" value="4" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-sky-500">
                <div class="flex justify-between text-sky-400 font-mono text-[10px] mt-1 mb-4">
                    <span>2 pts</span> <span id="pointCountLabel">4</span> <span>10 pts</span>
                </div>
                <div id="slider-panel" class="flex-1 bg-slate-800/50 p-2 rounded"></div>
                <button onclick="saveConfig()" class="w-full bg-green-600 hover:bg-green-500 text-white py-3 rounded font-bold transition mt-4">SAVE CONFIGURATION</button>
            </div>
        </div>

        <div id="safety-side-picker" class="hidden absolute inset-0 bg-black/80 flex items-center justify-center z-[2000]">
            <div class="bg-slate-900 border border-slate-700 p-8 rounded-xl text-center w-[450px]">
                <h3 class="text-lg font-bold text-white mb-6">SELECT SAFE PLATFORM SIDE</h3>
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="setSafetySide('left')" class="bg-slate-800 hover:bg-green-900/40 border border-slate-600 p-6 rounded-lg transition">
                        <i class="fa-solid fa-arrow-left text-green-500 text-2xl mb-2"></i>
                        <div class="text-white font-bold">LEFT SIDE</div>
                    </button>
                    <button onclick="setSafetySide('right')" class="bg-slate-800 hover:bg-green-900/40 border border-slate-600 p-6 rounded-lg transition">
                        <i class="fa-solid fa-arrow-right text-green-500 text-2xl mb-2"></i>
                        <div class="text-white font-bold">RIGHT SIDE</div>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getFirestore, doc, setDoc, collection, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyBoWtfLODLrDhRKkMew0sLceDgHBNAQAPM", 
            projectId: "metro-safety-system", 
            databaseURL: "https://metro-safety-system-default-rtdb.firebaseio.com" 
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        function isUnsafe(personX, personY) {
        if (controlPoints.length < 1) return false;
        
        // Basic Left/Right check based on your preference
        if (sidePreference === 'left') {
            // If Left is safe, person is unsafe if they are to the RIGHT of the line
            return personX > controlPoints[0].x;
        } else {
            // If Right is safe, person is unsafe if they are to the LEFT of the line
            return personX < controlPoints[0].x;
        }
    }
        window.processDetection = (pX, pY) => {
        console.log(`Processing detection at X: ${pX}, Y: ${pY}`);
        if (isUnsafe(pX, pY)) {
            console.warn("VIOLATION DETECTED!");
            triggerFaceCapture();
        } else {
            console.log("Person is in SAFE zone.");
        }
    };
        let controlPoints = [];
        let n = 4;
        let sidePreference = 'left'; 

        function initPoints(count) {
            controlPoints = Array.from({length: count}, (_, i) => ({ x: i / (count - 1), y: 0.5 }));
            renderSliders();
            drawLines();
        }

        window.updatePoint = (index, axis, val) => {
            controlPoints[index][axis] = val / 100;
            const labels = document.querySelectorAll('.pos-label');
            if(labels[index]) {
                labels[index].innerText = `X:${Math.round(controlPoints[index].x*100)}% Y:${Math.round(controlPoints[index].y*100)}%`;
            }
            drawLines();
        };

        function renderSliders() {
            const panel = document.getElementById('slider-panel');
            panel.innerHTML = '';
            controlPoints.forEach((pt, i) => {
                const group = document.createElement('div');
                group.className = "p-3 bg-black/40 border border-slate-700 rounded-lg mb-4";
                group.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-green-500 font-bold text-[10px]">POINT ${i + 1}</span>
                        <span class="pos-label text-[9px] text-slate-500 font-mono">X:${Math.round(pt.x*100)}% Y:${Math.round(pt.y*100)}%</span>
                    </div>
                    <div class="space-y-3">
                        <input type="range" min="0" max="100" value="${pt.x * 100}" oninput="window.updatePoint(${i}, 'x', this.value)" class="w-full h-1 bg-slate-700 appearance-none accent-sky-500">
                        <input type="range" min="0" max="100" value="${pt.y * 100}" oninput="window.updatePoint(${i}, 'y', this.value)" class="w-full h-1 bg-slate-700 appearance-none accent-red-500">
                    </div>`;
                panel.appendChild(group);
            });
        }

        function drawLines() {
            const overlays = ['safety-overlay', 'config-overlay'];
            overlays.forEach(id => {
                const svg = document.getElementById(id);
                const video = document.getElementById('config-video');
                const w = video.clientWidth || svg.parentElement.clientWidth;
                const h = video.clientHeight || svg.parentElement.clientHeight;
                svg.setAttribute('viewBox', `0 0 ${w} ${h}`);

                if (controlPoints.length < 2) return;

                let d = `M ${controlPoints[0].x * w} ${controlPoints[0].y * h}`;
                for (let i = 1; i < controlPoints.length; i++) d += ` L ${controlPoints[i].x * w} ${controlPoints[i].y * h}`;

                let unsafeD = d;
                if (sidePreference === 'left') {
                    unsafeD += ` L ${w} ${controlPoints[controlPoints.length-1].y * h} L ${w} ${h} L ${controlPoints[0].x * w} ${h} Z`;
                } else {
                    unsafeD += ` L 0 ${controlPoints[controlPoints.length-1].y * h} L 0 ${h} L ${controlPoints[0].x * w} ${h} Z`;
                }

                svg.innerHTML = `
                    <path d="${unsafeD}" class="unsafe-overlay-tint" />
                    <path d="${d}" stroke="#00ff00" stroke-width="5" fill="none" stroke-linecap="round" />
                    ${controlPoints.map(p => `<circle cx="${p.x * w}" cy="${p.y * h}" r="4" fill="white" />`).join('')}`;
            });
        }
/**
 * CAPTURE LOGIC: Snapshots the monitor feed and uploads to Master Portal
 * This function is triggered automatically when a person is detected in an unsafe zone.
 */
async function triggerFaceCapture() {
    // 1. Target the Master's Live Monitor Video
    const video = document.getElementById('monitor-video');
    if (!video || video.readyState < 2) {
        console.error("Capture Failed: Monitor video stream not ready.");
        return;
    }

    // 2. Create an Off-screen Canvas to render the snapshot
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;   // Use actual video resolution for 100% zoom
    canvas.height = video.videoHeight;
    
    const ctx = canvas.getContext('2d');
    
    // 3. Draw the current frame from the video to the canvas
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    
    // 4. Convert the snapshot to a Base64 JPEG string (0.7 quality for speed)
    const faceDataUrl = canvas.toDataURL('image/jpeg', 0.7);
    
    try {
        // 5. Generate a unique ID for the violation
        const violationId = `VIO-${Date.now()}`;
        
        // 6. Save data to Firebase Firestore 'violations' collection
        // This is what the Master Portal Listener picks up in real-time
        await setDoc(doc(db, "violations", violationId), {
            timestamp: new Date().toISOString(),
            image_data: faceDataUrl,
            status: "UNAUTHORIZED_TRACK_ACCESS",
            station: "HOWRAH_STN_01",
            processed: false
        });
        
        console.log(`Master Portal: Violation ${violationId} successfully logged.`);
        
        // 7. Optional: Visual confirmation for the Master on the current page
        const feed = document.getElementById('alerts-feed');
        if (feed) {
            const card = document.createElement('div');
            card.className = "bg-red-900/40 border border-red-500 p-2 mb-2 rounded animate-pulse";
            card.innerHTML = `
                <div class="flex justify-between text-[8px] text-red-400 mb-1 font-bold">
                    <span>INTRUSION DETECTED</span>
                    <span>${new Date().toLocaleTimeString()}</span>
                </div>
                <img src="${faceDataUrl}" class="w-full h-24 object-cover rounded">
            `;
            feed.prepend(card);
        }
        
    } catch (e) {
        console.error("Critical: Firestore Sync Failed", e);
    }
}
        // --- MASTER PORTAL LIVE VIOLATION LISTENER ---
        function startViolationListener() {
            const q = query(collection(db, "violations"), orderBy("timestamp", "desc"));
            onSnapshot(q, (snapshot) => {
                const feed = document.getElementById('alerts-feed');
                feed.innerHTML = "";
                if (snapshot.empty) {
                    feed.innerHTML = `<div class="text-center text-slate-500 mt-10 italic text-sm">System Armed. No violations.</div>`;
                    return;
                }
                snapshot.forEach(snap => {
                    const data = snap.data();
                    const card = document.createElement('div');
                    card.className = "bg-red-900/30 border border-red-600/50 p-3 mb-3 rounded-lg animate-pulse";
                    card.innerHTML = `
                        <div class="flex justify-between text-[8px] text-red-400 font-bold mb-2">
                            <span>ID: ${snap.id.substring(0,8)}</span>
                            <span>${new Date(data.timestamp).toLocaleTimeString()}</span>
                        </div>
                        <img src="${data.image_data}" class="w-full h-32 object-cover rounded border border-red-900 mb-2">
                        <div class="text-[10px] text-white">STATUS: TRACK INTRUSION</div>
                    `;
                    feed.prepend(card);
                });
            });
        }

        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 1280, height: 720 } });
                document.getElementById('monitor-video').srcObject = stream;
                document.getElementById('config-video').srcObject = stream;
            } catch (err) {
                document.querySelectorAll('.video-wrapper').forEach(v => v.classList.add('camera-error'));
            }
        }

        window.saveConfig = () => document.getElementById('safety-side-picker').classList.remove('hidden');

        window.setSafetySide = async (side) => {
            sidePreference = side;
            drawLines();
            try {
                await setDoc(doc(db, "config", "station_settings"), { poly_points: controlPoints, safe_side: sidePreference, updated_at: new Date().toISOString() });
                document.getElementById('safety-side-picker').classList.add('hidden');
                window.switchTab('monitor');
            } catch (e) { console.error("Save Error:", e); }
        };

        window.switchTab = (tab) => {
            document.getElementById('view-monitor').classList.toggle('hidden', tab !== 'monitor');
            document.getElementById('view-config').classList.toggle('hidden', tab !== 'config');
            document.getElementById('tab-monitor').classList.toggle('active', tab === 'monitor');
            document.getElementById('tab-config').classList.toggle('active', tab === 'config');
            setTimeout(drawLines, 50);
        };

        document.getElementById('pointCount').oninput = (e) => {
            n = parseInt(e.target.value);
            document.getElementById('pointCountLabel').innerText = n;
            initPoints(n);
        };

        window.addEventListener('resize', drawLines);
        setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString(); }, 1000);
        
        startCamera();
        initPoints(4);
        startViolationListener();
        const resizeObserver = new ResizeObserver(() => drawLines());
        document.querySelectorAll('.video-wrapper').forEach(div => resizeObserver.observe(div));
    </script>
</body>
</html>
