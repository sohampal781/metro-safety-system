<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metro Safety | Station Master Console</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #000000; color: #cccccc; overflow: hidden; font-family: 'Courier New', monospace; text-transform: uppercase; }
        .bg-slate-900, .bg-slate-800 { background-color: #0a0a0a !important; border-color: #333 !important; }
        .nav-btn { padding: 12px 24px; border-right: 1px solid #222; color: #555; font-weight: bold; background: #000; cursor: pointer; transition: 0.2s; }
        .nav-btn.active { color: #00ff00; background: #051a05; border-bottom: 2px solid #00ff00; }
        
        .video-wrapper { position: relative; width: 100%; height: 100%; background: #000; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        video { width: 100% !important; height: 100% !important; object-fit: cover; position: absolute; top: 0; left: 0; }
        svg { position: absolute; top: 0; left: 0; width: 100% !important; height: 100% !important; z-index: 10; pointer-events: none; }

        #slider-panel { display: block !important; overflow-y: auto !important; max-height: calc(100vh - 220px); padding-bottom: 40px; }
        #slider-panel::-webkit-scrollbar { width: 6px; }
        #slider-panel::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        #slider-panel::-webkit-scrollbar-thumb:hover { background: #00ff00; }

        .unsafe-overlay-tint { fill: rgba(220, 38, 38, 0.4); pointer-events: none; }
        .camera-error { background: repeating-linear-gradient(45deg, #000, #000 10px, #050505 10px, #050505 20px); display: flex; align-items: center; justify-content: center; color: #333; font-size: 10px; }
    </style>
</head>
<body class="flex flex-col h-screen">

    <header class="h-14 bg-slate-900 border-b border-slate-700 flex justify-between items-center px-4 shrink-0">
        <div class="flex items-center gap-4">
            <div class="text-xl font-bold text-white tracking-tight">
                <i class="fa-solid fa-subway text-sky-500 mr-2"></i>SURVEILLANCE <span class="text-green-500">COMMAND</span>
            </div>
            <nav class="flex">
                <button onclick="switchTab('monitor')" id="tab-monitor" class="nav-btn active">LIVE MONITOR</button>
                <button onclick="switchTab('config')" id="tab-config" class="nav-btn">ZONE CONFIG</button>
                <button onclick="switchTab('prosecute')" id="tab-prosecute" class="nav-btn">PROSECUTION LOG</button>
            </nav>
        </div>
        <div class="text-xs text-slate-500 font-mono text-right">
            <div id="clock">12:00:00</div>
            <div>CAM-01 [MASTER]</div>
        </div>
    </header>

    <main class="flex-1 relative overflow-hidden">
        <div id="view-monitor" class="absolute inset-0 grid grid-cols-[1fr_400px]">
            <div class="video-wrapper">
                <video id="monitor-video" autoplay playsinline muted></video>
                <svg id="safety-overlay"></svg>
            </div>
            <div class="bg-slate-800 border-l border-slate-700 flex flex-col p-4">
                <h3 class="font-bold text-white border-b border-slate-700 pb-2 mb-4 text-sm">MASTER VIOLATION FEED</h3>
                <div id="alerts-feed" class="flex-1 overflow-y-auto space-y-3">
                    <div class="text-center text-slate-500 mt-10 italic text-sm">System Armed. No violations.</div>
                </div>
            </div>
        </div>
<div id="view-monitor" class="absolute inset-0 grid grid-cols-[1fr_400px]">
    <div class="video-wrapper">
        <video id="monitor-video" autoplay playsinline muted></video>
        <svg id="safety-overlay"></svg>
        <button onclick="triggerFaceCapture('MANUAL_SNAP')" class="absolute bottom-10 right-10 bg-red-600 hover:bg-red-700 text-white p-4 rounded-full shadow-2xl z-50">
            <i class="fa-solid fa-camera text-2xl"></i>
        </button>
    </div>
    </div>

<div id="view-prosecute" class="absolute inset-0 hidden bg-slate-900 p-6 overflow-y-auto">
    <div class="flex justify-between items-center border-b border-slate-700 pb-4 mb-6">
        <h2 class="text-xl font-bold text-white">E-PROSECUTION DATABASE</h2>
        <span class="text-xs text-slate-500">STATION: HOWRAH_MAIN</span>
    </div>
    <div id="prosecution-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        </div>
</div>
        <div id="view-config" class="absolute inset-0 hidden grid grid-cols-[1fr_350px] bg-slate-900">
            <div class="video-wrapper relative">
                <video id="config-video" autoplay playsinline muted class="opacity-50"></video>
                <svg id="config-overlay"></svg>
            </div>
            <div class="bg-slate-800 border-l border-slate-700 flex flex-col p-4">
                <h3 class="font-bold text-white mb-4 text-sm">ZONE PARAMETERS</h3>
                <label class="text-[10px] text-slate-500 block mb-1">CONTROL POINTS (N)</label>
                <input id="pointCount" type="range" min="2" max="10" value="4" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-sky-500">
                <div class="flex justify-between text-sky-400 font-mono text-[10px] mt-1 mb-4">
                    <span>2 pts</span> <span id="pointCountLabel">4</span> <span>10 pts</span>
                </div>
                <div id="slider-panel" class="flex-1 bg-slate-800/50 p-2 rounded"></div>
                <button onclick="saveConfig()" class="w-full bg-green-600 hover:bg-green-500 text-white py-3 rounded font-bold transition mt-4">SAVE CONFIGURATION</button>
            </div>
        </div>

        <div id="safety-side-picker" class="hidden absolute inset-0 bg-black/80 flex items-center justify-center z-[2000]">
            <div class="bg-slate-900 border border-slate-700 p-8 rounded-xl text-center w-[450px]">
                <h3 class="text-lg font-bold text-white mb-6">SELECT SAFE PLATFORM SIDE</h3>
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="setSafetySide('left')" class="bg-slate-800 hover:bg-green-900/40 border border-slate-600 p-6 rounded-lg transition">
                        <i class="fa-solid fa-arrow-left text-green-500 text-2xl mb-2"></i>
                        <div class="text-white font-bold">LEFT SIDE</div>
                    </button>
                    <button onclick="setSafetySide('right')" class="bg-slate-800 hover:bg-green-900/40 border border-slate-600 p-6 rounded-lg transition">
                        <i class="fa-solid fa-arrow-right text-green-500 text-2xl mb-2"></i>
                        <div class="text-white font-bold">RIGHT SIDE</div>
                    </button>
                </div>
            </div>
        </div>
    </main>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { 
        getFirestore, doc, setDoc, collection, query, 
        orderBy, onSnapshot, deleteDoc 
    } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    // 1. DATABASE CONFIGURATION
    const firebaseConfig = { 
        apiKey: "AIzaSyBoWtfLODLrDhRKkMew0sLceDgHBNAQAPM", 
        projectId: "metro-safety-system", 
        databaseURL: "https://metro-safety-system-default-rtdb.firebaseio.com" 
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // 2. GLOBAL STATE
    let controlPoints = [];
    let n = 4;
    let sidePreference = 'left'; 

    // 3. DETECTION ENGINE (Accessed by AI/Console)
    function isUnsafe(personX, personY) {
        if (controlPoints.length < 1) return false;
        // Logic: Compare person X with the boundary line X
        return sidePreference === 'left' ? personX > controlPoints[0].x : personX < controlPoints[0].x;
    }

    window.processDetection = (pX, pY) => {
        if (isUnsafe(pX, pY)) {
            console.warn("AUTO-VIOLATION DETECTED");
            triggerFaceCapture('AUTO_DETECTION');
        }
    };

    // 4. IMAGE CAPTURE ENGINE (Manual & Auto)
    window.triggerFaceCapture = async (type = 'MANUAL_SNAP') => {
        const video = document.getElementById('monitor-video');
        if (!video || video.readyState < 2) return;

        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        
        const faceDataUrl = canvas.toDataURL('image/jpeg', 0.6);
        const recordId = `VIO-${Date.now()}`;

        try {
            await setDoc(doc(db, "violations", recordId), {
                timestamp: new Date().toISOString(),
                image_data: faceDataUrl,
                type: type,
                station: "HOWRAH_MASTER_01"
            });
        } catch (e) { console.error("Database Sync Error:", e); }
    };

    // 5. PROSECUTION LOG & DELETE LOGIC
    function startProsecutionListener() {
        const q = query(collection(db, "violations"), orderBy("timestamp", "desc"));
        onSnapshot(q, (snapshot) => {
            // Update Mini-Feed on Monitor
            const feed = document.getElementById('alerts-feed');
            // Update Main Prosecution Tab
            const list = document.getElementById('prosecution-list');
            
            if (feed) feed.innerHTML = "";
            if (list) list.innerHTML = "";

            snapshot.forEach(snap => {
                const d = snap.data();
                const card = createViolationCard(snap.id, d);
                if (list) list.appendChild(card);
                
                // Also add a simplified version to the live feed
                if (feed) {
                    const miniCard = document.createElement('div');
                    miniCard.className = "bg-red-900/30 border-l-4 border-red-500 p-2 mb-2 animate-pulse";
                    miniCard.innerHTML = `<img src="${d.image_data}" class="w-full h-20 object-cover rounded">`;
                    feed.appendChild(miniCard);
                }
            });
        });
    }

    function createViolationCard(id, data) {
        const div = document.createElement('div');
        div.className = "bg-slate-800 border border-slate-700 rounded overflow-hidden shadow-xl";
        div.innerHTML = `
            <img src="${data.image_data}" class="w-full h-40 object-cover">
            <div class="p-3">
                <div class="flex justify-between text-[10px] text-slate-400 mb-2">
                    <span class="font-bold text-red-500">${data.type}</span>
                    <span>${new Date(data.timestamp).toLocaleTimeString()}</span>
                </div>
                <button onclick="deleteRecord('${id}')" class="w-full bg-red-900/20 hover:bg-red-600 text-red-400 hover:text-white py-2 text-[10px] transition">
                    DELETE FROM RECORDS
                </button>
            </div>
        `;
        return div;
    }

    window.deleteRecord = async (id) => {
        if (confirm("Permanently delete this prosecution record?")) {
            try {
                await deleteDoc(doc(db, "violations", id));
            } catch (e) { alert("Delete failed: " + e.message); }
        }
    };

    // 6. UI & SYSTEM UTILS
    window.switchTab = (tab) => {
        document.querySelectorAll('main > div').forEach(div => div.classList.add('hidden'));
        document.getElementById(`view-${tab}`).classList.remove('hidden');
        document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`tab-${tab}`).classList.add('active');
        if (tab === 'config' || tab === 'monitor') setTimeout(drawLines, 50);
    };

    // ... [Include initPoints, updatePoint, renderSliders, drawLines, startCamera from previous steps] ...
    
    // START SERVICES
    startCamera();
    initPoints(4);
    startProsecutionListener();
</script>
</body>
</html>
